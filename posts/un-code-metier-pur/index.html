<!DOCTYPE html>
<html><meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'none'; style-src 'self' 'sha256-hevimW2qBMcsaZR62OkETyNJKvnMSjRYOz6kIyvEFtg='; img-src 'self'; connect-src 'self'; base-uri 'self'; manifest-src 'self'; media-src 'self'">
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Un code mÃ©tier pur Â· Romain Berthon</title>



<link rel="stylesheet" href="/css/rocinante.css" />
<link rel="shortcut icon" href="https://berthon.dev//favicon.ico">


<body>
    <header><nav>
  
    <a class="home" href="https://berthon.dev/">â€¹ Home</a>
  
  <div></div>
  <div>
    <a href="https://berthon.dev//tags/post">Posts</a>
    <a href="https://berthon.dev//tags/talk">Talks</a>
    
    <a href="https://berthon.dev//about">About</a>
    
  </div>
</nav>
</header>
    <main>

    <div class="post">
        <div class="title-group">
            <div class="title">
                <h1>Un code mÃ©tier pur</h1>
            </div>
            <div class="date"><h5>Feb 04, 2020</h5></div>
        </div>
        <article class="content">
            <p>Il y a quelques jours, au cours dâ€™une discussion, on mâ€™a demandÃ© quelles sont les pratiques que je pousse dans une Ã©quipe dans le but dâ€™amÃ©liorer la qualitÃ© de code. Bon nombre de pratiques comme TDD, clean code ou encore DDD et ses bounded-contexts ayant dÃ©jÃ  Ã©tÃ© citÃ©s, jâ€™ai donc rÃ©ponduÂ : un code mÃ©tier pur, parfois appelÃ© <a href="https://thinkbeforecoding.com/post/2018/01/25/functional-core" target="_blank">functional core</a>.</p>
<p>Dans cet article, je pars du principe que vous faite une distinction et sÃ©paration forte entre le code mÃ©tier qui rÃ©pond Ã  une logique business, et le code infra qui rÃ©pond aux problÃ©matiques techniques.</p>
<h2 id="quels-intÃ©rÃªtsnbsp">Quels intÃ©rÃªtsÂ ?</h2>
<p>Un code que lâ€™on peut qualifier de pur a deux caractÃ©ristiquesÂ :</p>
<ul>
<li>Celui-ci retourne toujours le mÃªme rÃ©sultat pour les mÃªmes entrÃ©es. Il ne dÃ©pend donc dâ€™aucun Ã©tat interne ni dâ€™appels Ã  des dÃ©pendances (base de donnÃ©es, heure systÃ¨me, etc.)</li>
<li>Il ne modifie aucun Ã©tat visible du systÃ¨me.</li>
</ul>
<p>Les raisons pour lesquelles je pousse ce genre de pratiques sont extrÃªmement simples. Il mâ€™est trÃ¨s facile de raisonner sur ce code puisque son comportement est Ã  la fois prÃ©dictible et rÃ©pÃ©table.</p>
<p>Il est Ã©galement trÃ¨s simple de rÃ©diger des tests pour ce genre de code. Vous pouvez donc dÃ©crire tous vos cas mÃ©tiers sous cette formeÂ : â€œmon systÃ¨me est dans cet Ã©tat, je lance cette action, alors jâ€™obtiens ce rÃ©sultatâ€.</p>
<p>Par exemple, un scÃ©nario pour la rÃ©servation dâ€™un parkingÂ :</p>
<ul>
<li>Jâ€™ai renseignÃ© mes dates et heures dâ€™arrivÃ©e et de dÃ©part.</li>
<li>Je valide ma rÃ©servation.</li>
<li>Ma rÃ©servation est acceptÃ©e pour les dates.</li>
</ul>
<p>Si lâ€™on peut parfois considÃ©rer les problÃ¨mes de charge comme inhÃ©rents au mÃ©tier, on a tout de mÃªme envie de les traiter comme des problÃ©matiques techniques. GÃ©rer lâ€™accÃ¨s Ã  un Ã©tat partagÃ© sur lequel on souhaite Ã©crire se rÃ©vÃ¨le vite complexe (usage de lock, de transactions par exemple) et empÃªche un code scaler. Nous ne voulons donc pas polluer de la logique mÃ©tier avec ce genre de problÃ©matiquesÂ : garder le code pur est une faÃ§on simple de sâ€™en assurer.</p>
<h2 id="la-raison-dÃªtre-dun-logiciel">La raison dâ€™Ãªtre dâ€™un logiciel</h2>
<p>Cependant, si nous Ã©crivons des logiciels, câ€™est souvent pour produire ce que nous qualifions jusquâ€™Ã  maintenant dâ€™effet de bordsÂ : Ã©crire en base de donnÃ©es, envoyer un mail, une notification, etc. Nous devons donc Ãªtre capable de passer dâ€™un code pur Ã  impure et inversement.</p>
<p>Une faÃ§on (peut-Ãªtre simpliste) de voir un logiciel est une succession de transformations de donnÃ©es. Je veux lire une donnÃ©e sur mon disque dur (imprÃ©dictible), puis la transformer (prÃ©dictible) et enfin Ã©crire le rÃ©sultat sur mon disque (imprÃ©dictible).</p>
<h2 id="comment-faire-vivre-les-deuxnbsp">Comment faire vivre les deuxÂ ?</h2>
<p>Nous avons vu jusquâ€™ici quâ€™il doit y avoir une distinction claire entre, le code mÃ©tier que lâ€™on veut pure, et le code infra qui lui est nÃ©cessairement impure puisque sa responsabilitÃ© est de traiter avec des appels rÃ©seaux et systÃ¨me.</p>
<p>Pour faire cohabiter ces deux mondes, il nous faut donc un bout de code dont la seule responsabilitÃ© estÂ :</p>
<ol>
<li>De rÃ©cupÃ©rer les donnÃ©es nÃ©cessaires Ã  une opÃ©ration mÃ©tier.</li>
<li>Appeler le code mÃ©tier.</li>
<li>Envoyer le rÃ©sultat Ã  la couche dâ€™infrastructure.</li>
</ol>
<p>RÃ©pondre Ã  cette problÃ©matique de sÃ©paration mÃ©tier/infra est la principale motivation derriÃ¨re lâ€™<a href="https://medium.com/publicis-sapient-france" target="_blank">architecture hexagonale</a>. Dans cette architecture, nos services portent cette responsabilitÃ©Â :</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Csharp" data-lang="Csharp"><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">MyService</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">readonly</span> <span style="color:#111">IRepository</span> <span style="color:#111">_repository</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">MyService</span><span style="color:#111">(</span><span style="color:#111">IRepository</span> <span style="color:#111">repository</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">_repository</span> <span style="color:#111">=</span> <span style="color:#111">repository</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">async</span> <span style="color:#111">Task</span> <span style="color:#111">DoSomething</span><span style="color:#111">(</span><span style="color:#00a8c8">int</span> <span style="color:#111">id</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#111">data</span> <span style="color:#111">=</span> <span style="color:#00a8c8">await</span> <span style="color:#111">_repository</span><span style="color:#111">.</span><span style="color:#111">Load</span><span style="color:#111">(</span><span style="color:#111">id</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#111">result</span> <span style="color:#111">=</span> <span style="color:#111">Business</span><span style="color:#111">.</span><span style="color:#111">Function</span><span style="color:#111">(</span><span style="color:#111">data</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">await</span> <span style="color:#111">_repository</span><span style="color:#111">.</span><span style="color:#111">Save</span><span style="color:#111">(</span><span style="color:#111">result</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Avec une architecture CQRS ou CQRS/ES, ce rÃ´le est portÃ© par le commandHandler.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Csharp" data-lang="Csharp"><span style="display:flex;"><span><span style="color:#00a8c8">public</span> <span style="color:#00a8c8">class</span> <span style="color:#75af00">MyCommandHandler</span> <span style="color:#111">:</span> <span style="color:#111">ICommandHandler</span><span style="color:#111">&lt;</span><span style="color:#111">MyCommand</span><span style="color:#111">&gt;</span> 
</span></span><span style="display:flex;"><span><span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">private</span> <span style="color:#00a8c8">readonly</span> <span style="color:#111">IRepository</span> <span style="color:#111">_repository</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#111">MyCommandHandler</span><span style="color:#111">(</span><span style="color:#111">IRepository</span> <span style="color:#111">repository</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#111">_repository</span> <span style="color:#111">=</span> <span style="color:#111">repository</span><span style="color:#111">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">public</span> <span style="color:#00a8c8">async</span> <span style="color:#111">Task</span> <span style="color:#111">Handle</span><span style="color:#111">(</span><span style="color:#111">MyCommand</span> <span style="color:#111">cmd</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#111">aggregate</span> <span style="color:#111">=</span> <span style="color:#00a8c8">await</span> <span style="color:#111">_repository</span><span style="color:#111">.</span><span style="color:#111">Load</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#111">.</span><span style="color:#111">Id</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">var</span> <span style="color:#111">events</span> <span style="color:#111">=</span> <span style="color:#111">aggregate</span><span style="color:#111">.</span><span style="color:#111">RunLogic</span><span style="color:#111">(</span><span style="color:#111">cmd</span><span style="color:#111">.</span><span style="color:#111">arg1</span><span style="color:#111">,</span> <span style="color:#111">cmd</span><span style="color:#111">.</span><span style="color:#111">arg2</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">await</span> <span style="color:#111">_repository</span><span style="color:#111">.</span><span style="color:#111">Save</span><span style="color:#111">(</span><span style="color:#111">events</span><span style="color:#111">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">}</span>
</span></span><span style="display:flex;"><span><span style="color:#111">}</span>
</span></span></code></pre></div><p>Notez que la structure du code reste inchangÃ©e, seuls les types changent.</p>
<p>Ce pattern demande une certaine rigueur de la part des dÃ©veloppeurs, il est en effet facile dâ€™introduire des effets de bords dans le code mÃ©tier. Pour cette raison la stratÃ©gie adoptÃ©e par Haskell consiste Ã  encapsuler les effets de bord dans des <code>IO</code>  monade.</p>
<p>Je ne vais pas mâ€™aventurer ici Ã  dÃ©finir ce quâ€™est une monade, mais si vous nâ€™Ãªtes pas familier avec ce concept, voici une image trÃ¨s grossiÃ¨reÂ : Une monade est comme une boÃ®te contenant de la donnÃ©e, pour manipuler cette donnÃ©e, vous devez fournir Ã  la monade la fonction Ã  appliquer. Une liste est par exemple une monade, lâ€™<code>IO</code> monade en Haskell reprÃ©sente un effet de bord.</p>
<p>Dans cet exemple, jâ€™ouvre le fichier <code>input.txt</code>, jâ€™applique la fonction <code>toUpperString</code> puis jâ€™Ã©cris le rÃ©sultat dans le fichier <code>output.txt</code>. Jâ€™ai fait lâ€™effort ici de dÃ©composer les fonctions afin de voir les signatures.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-Haskell" data-lang="Haskell"><span style="display:flex;"><span><span style="color:#00a8c8">import</span> <span style="color:#111">Data.Char</span><span style="color:#111">(</span><span style="color:#111">toUpper</span><span style="color:#111">)</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">import</span> <span style="color:#111">Data.Functor</span><span style="color:#111">((</span><span style="color:#f92672">&lt;&amp;&gt;</span><span style="color:#111">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#00a8c8">Lowercase</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">String</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#00a8c8">Uppercase</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">String</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Code infra : impure</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">readInput</span> <span style="color:#f92672">::</span> <span style="color:#00a8c8">IO</span> <span style="color:#00a8c8">Lowercase</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">readInput</span> <span style="color:#f92672">=</span> <span style="color:#111">readFile</span> <span style="color:#d88200">&#34;input.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Code mÃ©tier : pure</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">toUpperString</span> <span style="color:#f92672">::</span> <span style="color:#00a8c8">Lowercase</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">Uppercase</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">toUpperString</span> <span style="color:#f92672">::</span> <span style="color:#111">map</span> <span style="color:#111">toUpper</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">-- Code infra : impure</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">writeOutput</span> <span style="color:#f92672">::</span> <span style="color:#00a8c8">Uppercase</span> <span style="color:#f92672">-&gt;</span> <span style="color:#00a8c8">IO</span> <span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">writeOutput</span> <span style="color:#f92672">=</span> <span style="color:#111">writeFile</span> <span style="color:#d88200">&#34;output.txt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">main</span> <span style="color:#f92672">::</span> <span style="color:#00a8c8">IO</span> <span style="color:#111">()</span>
</span></span><span style="display:flex;"><span><span style="color:#75af00">main</span> <span style="color:#f92672">=</span> <span style="color:#111">readInput</span> <span style="color:#f92672">&lt;&amp;&gt;</span> <span style="color:#111">toUpperString</span> <span style="color:#f92672">&gt;&gt;=</span> <span style="color:#111">writeOutput</span>
</span></span></code></pre></div><p>La transition du monde de lâ€™<code>IO</code> vers du code pur se fait grÃ¢ce Ã  une fonction appelÃ©e <code>fmap</code>, ici appelÃ©e via lâ€™opÃ©rateur <code>&lt;&amp;&gt;</code>. <code>fmap</code> prend une fonction pure et lâ€™applique un contenu dâ€™une <code>IO</code> pour produire une nouvelle <code>IO</code>. On obtient ici un <code>IO Uppercase</code>.</p>
<p>Enfin, pour Ã©crire le rÃ©sultat, on applique la fonction <code>writeOutput</code> via la mÃ©thode <code>bind</code> (opÃ©rateur <code>&gt;&gt;=</code>). <code>bind</code> nous permet dâ€™appliquer une fonction retournant une <code>IO</code> au contenu dâ€™une <code>IO</code>.</p>
<h2 id="out-of-the-tar-pit">Out of the tar pit</h2>
<p>Si cet article vu a plu et que vous souhaitez approfondir le sujet, je vous encourage Ã  lire le papier <a href="https://curtclifton.net/papers/MoseleyMarks06a.pdf" target="_blank">Out of the Tar Pit</a> qui traite de la complexitÃ© logiciel, et qui propose un dÃ©coupage similaire du code. Jâ€™ai dÃ©couvert ce papier grÃ¢ce Ã  un <a href="https://www.youtube.com/watch?v=lFiB-a3aqbE" target="_blank">talk</a> explicatif de <a href="https://twitter.com/malk_zameth" target="_blank">Romeu Moura</a>.</p>
<hr>
<h2 id="commentaires">Commentaires</h2>
<!--Ajoutez votre commentaire ici-->
<p>Envie de commenter ? Sâ€™il vous plaÃ®t, ajoutez votre commentaire en m&rsquo;<a href="https://github.com/RomainTrm/Blog?tab=readme-ov-file#how-to-comment" target="_blank">envoyant une pull request</a>.</p>

        </article>
        
            <div class="tags">
                <span title="Tags">ğŸ·</span>
                <div class="horizontal-links links">
                    <a href="/tags/post/">Post</a><a href="/tags/fr/">Fr</a>
                </div>
            </div>
        
    </article>


    </main>
    <footer>
  <div class="content-container">
    <div class="content"><div class="about">
  <h2>Romain Berthon</h2>
  Software developer, *DD and F# enthusiast

  
    <p class="horizontal-links"><a href="https://github.com/RomainTrm"
         target="_blank" 
        
        >Github</a><a href="https://bsky.app/profile/berthon.dev"
         target="_blank" 
        
        >Bsky</a><a href="https://fr.linkedin.com/in/romain-berthon-254977101"
         target="_blank" 
        
        >LinkedIn</a></p>
  
</div>
</div>
  </div>
</footer>
    </body>
</html>
