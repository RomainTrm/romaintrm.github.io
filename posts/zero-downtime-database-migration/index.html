<!DOCTYPE html>
<html><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>ZERO DOWNTIME DATABASE MIGRATION · Romain Berthon</title>



<link rel="stylesheet" href="/css/rocinante.css" />
<link rel="shortcut icon" href="favicon.ico">


<body>
    <header><nav>
  
    <a class="home" href="https://romaintrm.github.io/">‹ Home</a>
  
  <div></div>
  <div>
    <a href="https://romaintrm.github.io//tags/post">Posts</a>
    <a href="https://romaintrm.github.io//tags/talk">Talks</a>
    
      <a href="https://romaintrm.github.io//about-me">About me</a>
    
  </div>
</nav>
</header>
    <main>

    <div class="post">
        <div class="title-group">
            <div class="title">
                <h1>ZERO DOWNTIME DATABASE MIGRATION</h1>
            </div>
            <div class="date"><h5>Dec 04, 2024</h5></div>
        </div>
        <article class="content">
            <p>Nowadays, most of the services we&rsquo;re using are online and available 24/7. If, like me, you&rsquo;re working on a company that provide this kind of service, you&rsquo;re probably aiming for such availability. As I&rsquo;ve already <a href="/posts/2022-09-01/">highlighted it</a>, it has a huge influence on how you should code and deploy your software. Indeed, to maximize availability, you&rsquo;re probably aiming for a zero downtime deployment.</p>
<p>Zero downtime deployment includes several topics. Today I want to focus on how to achieve a database migration without service interruption.</p>
<h2 id="requirements">REQUIREMENTS</h2>
<p>First, be aware that database schema migration isn&rsquo;t the first topic you&rsquo;ll have to address to achieve zero downtime migrations.</p>
<p>As a requirement, you need to step up a deployment pipeline with at least a couple instances of your service and a proxy/load-balancer to route traffic on them. As we&rsquo;ll need to do several deployments, for your own safety and sanity it&rsquo;s better to fully automate this process.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 672 233"
      >
      <g transform='translate(8,16)'>
<path d='M 104,0 L 168,0' fill='none' stroke='currentColor'></path>
<path d='M 104,32 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 120,32 L 152,32' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 272,80' fill='none' stroke='currentColor'></path>
<path d='M 0,128 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,128 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 184,176' fill='none' stroke='currentColor'></path>
<path d='M 96,208 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 0,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 96,208' fill='none' stroke='currentColor'></path>
<path d='M 104,0 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 160,128' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 184,176 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 272,80 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 104,64 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 160,160 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,160' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,64' fill='none' stroke='currentColor'></path>
<path d='M 96,80 L 104,64' fill='none' stroke='currentColor'></path>
<polygon points='122.000000,64.000000 110.000000,58.400002 110.000000,69.599998' fill='currentColor' transform='rotate(120.000000, 104.000000, 64.000000)'></polygon>
<path d='M 112,160 L 120,176' fill='none' stroke='currentColor'></path>
<polygon points='130.000000,160.000000 118.000000,154.399994 118.000000,165.600006' fill='currentColor' transform='rotate(60.000000, 112.000000, 160.000000)'></polygon>
<path d='M 152,176 L 160,160' fill='none' stroke='currentColor'></path>
<polygon points='178.000000,160.000000 166.000000,154.399994 166.000000,165.600006' fill='currentColor' transform='rotate(120.000000, 160.000000, 160.000000)'></polygon>
<path d='M 168,64 L 176,80' fill='none' stroke='currentColor'></path>
<polygon points='186.000000,64.000000 174.000000,58.400002 174.000000,69.599998' fill='currentColor' transform='rotate(60.000000, 168.000000, 64.000000)'></polygon>
<circle cx='96' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<circle cx='176' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='196' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='136' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='144' y='196' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='152' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='160' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='196' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='176' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='232' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>0</text>
</g>

    </svg>
  
</div>
<p>Clients are calling our service through the proxy, it&rsquo;s in charge to dispatch requests to our instances.<br>
When deploying a new version, you need to proceed a rolling update. The first step is to update the proxy to call only one instance, then you can update the isolated one.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 672 233"
      >
      <g transform='translate(8,16)'>
<path d='M 104,0 L 168,0' fill='none' stroke='currentColor'></path>
<path d='M 104,32 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 120,32 L 152,32' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 272,80' fill='none' stroke='currentColor'></path>
<path d='M 0,128 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,128 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 184,176' fill='none' stroke='currentColor'></path>
<path d='M 96,208 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 0,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 96,208' fill='none' stroke='currentColor'></path>
<path d='M 104,0 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 160,128' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 184,176 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 216,48 L 216,64' fill='none' stroke='currentColor'></path>
<path d='M 272,80 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 104,64 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 160,160 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,160' fill='none' stroke='currentColor'></path>
<path d='M 96,80 L 104,64' fill='none' stroke='currentColor'></path>
<polygon points='122.000000,64.000000 110.000000,58.400002 110.000000,69.599998' fill='currentColor' transform='rotate(120.000000, 104.000000, 64.000000)'></polygon>
<path d='M 112,160 L 120,176' fill='none' stroke='currentColor'></path>
<polygon points='130.000000,160.000000 118.000000,154.399994 118.000000,165.600006' fill='currentColor' transform='rotate(60.000000, 112.000000, 160.000000)'></polygon>
<path d='M 152,176 L 160,160' fill='none' stroke='currentColor'></path>
<polygon points='178.000000,160.000000 166.000000,154.399994 166.000000,165.600006' fill='currentColor' transform='rotate(120.000000, 160.000000, 160.000000)'></polygon>
<path d='M 216,64 L 216,72' fill='none' stroke='currentColor'></path>
<polygon points='232.000000,64.000000 220.000000,58.400002 220.000000,69.599998' fill='currentColor' transform='rotate(90.000000, 216.000000, 64.000000)'></polygon>
<circle cx='96' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<circle cx='176' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='196' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='136' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='144' y='196' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='152' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='160' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='196' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='176' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='200' y='36' fill='currentColor' style='font-size:1em'>U</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='232' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='232' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>0</text>
</g>

    </svg>
  
</div>
<p>Once updated, change the proxy to route all traffic to the updated instance. Now you can update the old one.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 672 233"
      >
      <g transform='translate(8,16)'>
<path d='M 104,0 L 168,0' fill='none' stroke='currentColor'></path>
<path d='M 104,32 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 120,32 L 152,32' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 272,80' fill='none' stroke='currentColor'></path>
<path d='M 0,128 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,128 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 184,176' fill='none' stroke='currentColor'></path>
<path d='M 96,208 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 0,128' fill='none' stroke='currentColor'></path>
<path d='M 48,48 L 48,64' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 96,208' fill='none' stroke='currentColor'></path>
<path d='M 104,0 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 160,128' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 184,176 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 272,80 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 160,160 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,160' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,64' fill='none' stroke='currentColor'></path>
<path d='M 48,64 L 48,72' fill='none' stroke='currentColor'></path>
<polygon points='64.000000,64.000000 52.000000,58.400002 52.000000,69.599998' fill='currentColor' transform='rotate(90.000000, 48.000000, 64.000000)'></polygon>
<path d='M 112,160 L 120,176' fill='none' stroke='currentColor'></path>
<polygon points='130.000000,160.000000 118.000000,154.399994 118.000000,165.600006' fill='currentColor' transform='rotate(60.000000, 112.000000, 160.000000)'></polygon>
<path d='M 152,176 L 160,160' fill='none' stroke='currentColor'></path>
<polygon points='178.000000,160.000000 166.000000,154.399994 166.000000,165.600006' fill='currentColor' transform='rotate(120.000000, 160.000000, 160.000000)'></polygon>
<path d='M 168,64 L 176,80' fill='none' stroke='currentColor'></path>
<polygon points='186.000000,64.000000 174.000000,58.400002 174.000000,69.599998' fill='currentColor' transform='rotate(60.000000, 168.000000, 64.000000)'></polygon>
<circle cx='96' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<circle cx='176' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='24' y='36' fill='currentColor' style='font-size:1em'>U</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='196' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='136' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='144' y='196' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='152' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='160' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='196' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='176' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='232' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>0</text>
</g>

    </svg>
  
</div>
<p>Then you can resume to normal operation by dispatching requests to both instances.</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 672 233"
      >
      <g transform='translate(8,16)'>
<path d='M 104,0 L 168,0' fill='none' stroke='currentColor'></path>
<path d='M 104,32 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 120,32 L 152,32' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 112,80' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 272,80' fill='none' stroke='currentColor'></path>
<path d='M 0,128 L 96,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,128 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 176,128 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 184,176' fill='none' stroke='currentColor'></path>
<path d='M 96,208 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 0,80 L 0,128' fill='none' stroke='currentColor'></path>
<path d='M 96,176 L 96,208' fill='none' stroke='currentColor'></path>
<path d='M 104,0 L 104,32' fill='none' stroke='currentColor'></path>
<path d='M 112,80 L 112,128' fill='none' stroke='currentColor'></path>
<path d='M 160,80 L 160,128' fill='none' stroke='currentColor'></path>
<path d='M 168,0 L 168,32' fill='none' stroke='currentColor'></path>
<path d='M 184,176 L 184,208' fill='none' stroke='currentColor'></path>
<path d='M 272,80 L 272,128' fill='none' stroke='currentColor'></path>
<path d='M 104,64 L 120,32' fill='none' stroke='currentColor'></path>
<path d='M 160,160 L 176,128' fill='none' stroke='currentColor'></path>
<path d='M 96,128 L 112,160' fill='none' stroke='currentColor'></path>
<path d='M 152,32 L 168,64' fill='none' stroke='currentColor'></path>
<path d='M 96,80 L 104,64' fill='none' stroke='currentColor'></path>
<polygon points='122.000000,64.000000 110.000000,58.400002 110.000000,69.599998' fill='currentColor' transform='rotate(120.000000, 104.000000, 64.000000)'></polygon>
<path d='M 112,160 L 120,176' fill='none' stroke='currentColor'></path>
<polygon points='130.000000,160.000000 118.000000,154.399994 118.000000,165.600006' fill='currentColor' transform='rotate(60.000000, 112.000000, 160.000000)'></polygon>
<path d='M 152,176 L 160,160' fill='none' stroke='currentColor'></path>
<polygon points='178.000000,160.000000 166.000000,154.399994 166.000000,165.600006' fill='currentColor' transform='rotate(120.000000, 160.000000, 160.000000)'></polygon>
<path d='M 168,64 L 176,80' fill='none' stroke='currentColor'></path>
<polygon points='186.000000,64.000000 174.000000,58.400002 174.000000,69.599998' fill='currentColor' transform='rotate(60.000000, 168.000000, 64.000000)'></polygon>
<circle cx='96' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<circle cx='176' cy='128' r='6' stroke='currentColor' fill='currentColor'></circle>
<text text-anchor='middle' x='16' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='16' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='24' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='24' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='32' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='32' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='40' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='40' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='48' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='56' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='64' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='64' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='72' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='80' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='88' y='100' fill='currentColor' style='font-size:1em'>1</text>
<text text-anchor='middle' x='88' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='96' y='116' fill='currentColor' style='font-size:1em'>0</text>
<text text-anchor='middle' x='112' y='196' fill='currentColor' style='font-size:1em'>D</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='120' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='128' y='196' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='136' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>x</text>
<text text-anchor='middle' x='144' y='196' fill='currentColor' style='font-size:1em'>b</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>y</text>
<text text-anchor='middle' x='152' y='196' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='160' y='196' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='168' y='196' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='176' y='100' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='176' y='116' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='184' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='184' y='116' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='192' y='100' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='192' y='116' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='200' y='100' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='200' y='116' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='208' y='100' fill='currentColor' style='font-size:1em'>a</text>
<text text-anchor='middle' x='208' y='116' fill='currentColor' style='font-size:1em'>i</text>
<text text-anchor='middle' x='216' y='100' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='216' y='116' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='224' y='100' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='224' y='116' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='232' y='100' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='240' y='116' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='100' fill='currentColor' style='font-size:1em'>2</text>
<text text-anchor='middle' x='248' y='116' fill='currentColor' style='font-size:1em'>.</text>
<text text-anchor='middle' x='256' y='116' fill='currentColor' style='font-size:1em'>0</text>
</g>

    </svg>
  
</div>
<p>Now we&rsquo;re able to migrate our database without any service interruption.</p>
<h2 id="migration">MIGRATION</h2>
<p>Let&rsquo;s details steps for a zero downtime migration. The core idea is to always have a database schema supported by versions <em>N</em> and <em>N+1</em> of your software. Furthermore, it allows you to rollback the latest software deployment at any time if you detect a blocking issue.</p>
<p>Note: it&rsquo;s important to respect these steps, you cannot skip or reorder any of them.</p>
<h3 id="step-1-first-schema-migration">STEP 1: FIRST SCHEMA MIGRATION</h3>
<p>To begin, we have to deploy a first schema migration, but there is some constraints. For now, we&rsquo;re aiming for a schema that supports both old and new data format. We&rsquo;re not migrating the data yet.</p>
<p>It&rsquo;s already a tricky step because we don&rsquo;t want to accidentally lock a table for a long period of time. Long locks have an impact on our service: it can be perceived as slower by the users and some queries may timeout. This requires some knowledge about database behavior to avoid these.</p>
<p>We have to adopt different strategies depending of what type of migration we&rsquo;re targeting:</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Migration to apply</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add a new column, rename/edit an existing column</td>
<td>Create a new column without <code>NOT NULL</code> constraint, it&rsquo;s probably better to avoid <code>DEFAULT VALUE</code> too.</td>
</tr>
<tr>
<td>Remove a column</td>
<td>Remove existing <code>NOT NULL</code> constraint.</td>
</tr>
</tbody>
</table>
<h3 id="step-2-first-software-migration">STEP 2: FIRST SOFTWARE MIGRATION</h3>
<p>Time for the second deployment, now it&rsquo;s a software update. In this version, the shipped code must:</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Code behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add a new column</td>
<td>Write but do not read the new column.</td>
</tr>
<tr>
<td>Rename/edit an existing column</td>
<td>Write but do not read the new column. Keep writing and reading the old one.</td>
</tr>
<tr>
<td>Remove a column</td>
<td>Keep writing in the column but do not read it anymore.</td>
</tr>
</tbody>
</table>
<p>By doing so, we&rsquo;re maintaining the old schema and starting to fill the new one without exposing ourselves to the unpopulated data.</p>
<p>If you&rsquo;re using an <a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping" target="_blank">ORM</a> like Entity Framework to generate your requests, be very careful with the columns it accesses in its queries.</p>
<h3 id="step-3-migrate-data">STEP 3: MIGRATE DATA</h3>
<p>If we&rsquo;re only removing a column, we can skip this step. Otherwise, it&rsquo;s time to populate the new column.</p>
<p>To do so, we have to write and apply a script that fills unpopulated rows. As in <em>step 1</em>, we must avoid locking tables. The best strategy is probably to update a small number of lines in dedicated transactions and loop until the table is fully filled.</p>
<blockquote>
<p>Tip: once this is done, you can wait a bit to make sure you haven&rsquo;t forgotten to update a write request. In such case, new rows with empty values should appear.</p>
</blockquote>
<h3 id="step-4-second-software-migration">STEP 4: SECOND SOFTWARE MIGRATION</h3>
<p>Now we can migrate our software to our final target.</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Code behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add a new column</td>
<td>Write and read the new column.</td>
</tr>
<tr>
<td>Rename/edit an existing column</td>
<td>Write and read the new column. Note: You can choose not to write anymore in the old column, but it breaks the backward compatibility. You can delay this &ldquo;cleanup&rdquo; to a future version.</td>
</tr>
<tr>
<td>Remove a column</td>
<td>Do not read neither write the old column.</td>
</tr>
</tbody>
</table>
<h3 id="step-5-second-schema-migration">STEP 5: SECOND SCHEMA MIGRATION</h3>
<p>And finally, we have to cleanup the database.</p>
<table>
<thead>
<tr>
<th>Target</th>
<th>Code behavior</th>
</tr>
</thead>
<tbody>
<tr>
<td>Add a new column</td>
<td>Update constraints to add <code>NOT NULL</code> and <code>DEFAULT VALUE</code> (if needed).</td>
</tr>
<tr>
<td>Rename/edit an existing column</td>
<td>Update constraints to add <code>NOT NULL</code> and <code>DEFAULT VALUE</code> (if needed). If you chose not to write in the old column, you can drop it.</td>
</tr>
<tr>
<td>Remove a column</td>
<td>Do the column.</td>
</tr>
</tbody>
</table>
<p>In this step, we&rsquo;re not worried by locks because rows are filled: the application of these constraints does not trigger update of the rows.</p>
<h2 id="conclusion">CONCLUSION</h2>
<p>As we&rsquo;ve seen, this is not a straightforward procedure. It requires more work, the ability to manage intermediate versions and some continuous deployment culture from the team. However, it gives you a lot of freedom for deployment, you can ship a new version at any time. It can be beneficial if your clients are other businesses with high availability constraints, you will not be stuck maintaining several versions of your software because they don&rsquo;t want to stop their service for an update.</p>
<p>This migration process isn&rsquo;t always necessary (unless if you want to ensure backward compatibility). Well-isolated asynchronous processes can be updated with a service interruption, they will catch up when the process is resumed.</p>
<p>If you have full control of your deployment pipeline and you can ensure you are fully updating your database before starting to deploy the new software version, then this process can be optimized:</p>
<ul>
<li>merge <em>step 1</em> with <em>step 2</em></li>
<li>merge <em>step 3</em> with <em>step 4</em>, but as I mentioned it, waiting after <em>step 3</em> can increase your confidence in your migration</li>
</ul>
<h2 id="more-on-this-topic">MORE ON THIS TOPIC</h2>
<p>I recommend for my French readers this <a href="https://youtu.be/pIkA-aPtkNs" target="_blank">talk</a> that is way more detailed than this blog post.</p>
<hr>
<h2 id="comments">COMMENTS</h2>
<!--Add your comment here-->
<p>Wish to comment? Please, add your comment by <a href="https://github.com/RomainTrm/Blog?tab=readme-ov-file#how-to-comment" target="_blank">sending me a pull request</a>.</p>

        </article>
        
            <div class="tags">
                <span title="Tags">🏷</span>
                <div class="horizontal-links links">
                    <a href="/tags/post/">Post</a><a href="/tags/en/">En</a>
                </div>
            </div>
        
    </article>


    </main>
    <footer>
  <div class="content-container">
    <div class="content"><div class="about">
  <h2>Romain Berthon</h2>
  Software developer, *DD and F# enthusiast

  
    <p class="horizontal-links"><a href="https://github.com/RomainTrm"
         target="_blank" 
        
        >Github</a><a href="https://bsky.app/profile/romaintrm.bsky.social"
         target="_blank" 
        
        >Bsky</a><a href="https://fr.linkedin.com/in/romain-berthon-254977101"
         target="_blank" 
        
        >LinkedIn</a></p>
  
</div>
</div>
  </div>
</footer>
    
    <script>
      const emailId = atob("");
    </script></body>
</html>
