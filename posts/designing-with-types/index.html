<!DOCTYPE html>
<html><meta charset="utf-8">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'none'; style-src 'self' 'sha256-hevimW2qBMcsaZR62OkETyNJKvnMSjRYOz6kIyvEFtg='; img-src 'self'; connect-src 'self'; base-uri 'self'; manifest-src 'self'; media-src 'self'">
<meta http-equiv="Strict-Transport-Security" content="max-age=63072000; includeSubDomains; preload">
<meta http-equiv="X-Content-Type-Options" content="nosniff">
<meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Designing with types ¬∑ Romain Berthon</title>



<link rel="stylesheet" href="/css/rocinante.css" />
<link rel="shortcut icon" href="https://berthon.dev//favicon.ico">


<body>
    <header><nav>
  
    <a class="home" href="https://berthon.dev/">‚Äπ Home</a>
  
  <div></div>
  <div>
    <a href="https://berthon.dev//tags/post">Posts</a>
    <a href="https://berthon.dev//tags/talk">Talks</a>
    
    <a href="https://berthon.dev//about">About</a>
    
  </div>
</nav>
</header>
    <main>

    <div class="post">
        <div class="title-group">
            <div class="title">
                <h1>Designing with types</h1>
            </div>
            <div class="date"><h5>Apr 02, 2025</h5></div>
        </div>
        <article class="content">
            <p>When writing software, we&rsquo;re using types to represent the information we&rsquo;re manipulating. Values are express through primitive types like <code>bool</code>, <code>int</code> or <code>string</code>. We&rsquo;re building complex data representation by composing these types. This composition is done by defining our own types, usually with classes or tuples.</p>
<p>Even if there are several ways to store and represent the same information, these ways are not all equivalent. Some are too permissive and allows states that should be considered as illegal regarding our business rules. Others are well defined and only represent legal states, meaning we don&rsquo;t have to write code to defend ourselves against malformed data.</p>
<p>Did you know there&rsquo;s a mathematical way to compute the number of possible states of your model? We can then compare this number to the number of possible combinations for a business case and determine if our model allows illegal states or not.</p>
<h2 id="types-cardinality-the-number-of-possible-states">Type&rsquo;s cardinality: the number of possible states</h2>
<p>Every type we&rsquo;re using has a <a href="https://en.wikipedia.org/wiki/Cardinality" target="_blank">cardinality</a>. This is the number of possible states it allows.</p>
<p>For example, a <code>bool</code> has a cardinality of 2 (<code>true</code> or <code>false</code>), a <code>byte</code> has a cardinality of 2<sup>8</sup> (256 values from 0 to 255) and a <code>string</code> has virtually an infinity of values possible (in reality there&rsquo;s a hard limit defined by the available memory).</p>
<p>As I&rsquo;ve mentioned it, we&rsquo;re able to compose these types, so we should be able to compute the number of values possible.</p>
<p>For a pair of <code>bool</code>, we have 4 possible values (<code>false, false</code>, <code>true, false</code>, <code>false, true</code> and <code>true, true</code>). If we add a third <code>bool</code>, this number doubles to 8 possibilities. So types like classes or tuples act as mathematical products, they multiply the cardinality of each of their members.</p>
<p>There is a second category of types that acts as mathematical sums: union types. In F#, they are expressed like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyUnionType</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Foo</span> <span style="color:#00a8c8">of</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Bar</span>
</span></span></code></pre></div><p>With these, we only have one of the possible values at the time. So our value will be either <code>Foo</code> that is a <code>bool</code> or <code>Bar</code> that is a kind of constant. So our cardinality is then 2 + 1 = 3 possible values.</p>
<blockquote>
<p>Note these sum types are not natively supported in C#, even if some tricks exist to approach this behavior. <a href="https://bsky.app/profile/oskardudycz.bsky.social" target="_blank">Oskar Dudycz</a> did a great job in his <a href="https://event-driven.io/en/union_types_in_csharp/" target="_blank">blog post</a> explaining those.</p>
<p>Though one limitation remains: the compiler is unaware of the number of possible types. Even if the implementation of new types is restricted, there&rsquo;s theoretically an infinity of possible extensions of the base type. The only solution I&rsquo;ve found and used to avoid this issue is to implement the <a href="https://refactoring.guru/design-patterns/visitor" target="_blank">visitor pattern</a>. But this is an extremely verbose solution.</p>
</blockquote>
<p>We&rsquo;re now able to compute the number of possible states for our model.</p>
<h2 id="use-case-the-tennis-kata">Use case: the tennis kata</h2>
<p>We will use the <a href="https://sammancoaching.org/kata_descriptions/tennis.html" target="_blank">Tennis Kata</a> to highlight the use of the cardinality. We will compute the total number of states of our model and ensure we can&rsquo;t produce an invalid state. Our goal is to compute the new score of a &ldquo;game&rdquo;.</p>
<h3 id="the-rules-to-implement">The rules to implement</h3>
<p>There are two players: the &ldquo;serving player&rdquo; and his opponent. Each mark points: &ldquo;love&rdquo; (0 points), 15, 30 and then 40 points.</p>
<p>A score is expressed as a pair of points, like &ldquo;15-30&rdquo; or &ldquo;40-love&rdquo;. By convention, the point of the serving player is always the first.</p>
<p>To win the game, a player must mark a new point when his score is 40. In the case of a &ldquo;deuce&rdquo; (40-40), the player who marks gets an &ldquo;advantage&rdquo;, if he marks again then he wins, otherwise the score goes back to &ldquo;deuce&rdquo;.</p>
<h3 id="the-number-of-possible-states">The number of possible states</h3>
<p>Now let&rsquo;s compute the number of possible states. We&rsquo;ve got two players, each of them can have 4 possible points values (&ldquo;love&rdquo;, 15, 30, 40). Each player can gain the advantage (2 possible values) and win the game (2 possible values).</p>
<p>So our cardinality is:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>4 points * 4 points + 2 combinations of advantage + 2 combinations of games won
</span></span><span style="display:flex;"><span>4 * 4 + 2 + 2
</span></span><span style="display:flex;"><span>20
</span></span></code></pre></div><p>Our model should have a cardinality of 20 possible states.</p>
<h3 id="naive-implementation">Naive implementation</h3>
<p>The naive (and tempting?) way to implement the score is a pair of numbers (let says <code>byte</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Score</span> <span style="color:#f92672">=</span> <span style="color:#00a8c8">byte</span> <span style="color:#f92672">*</span> <span style="color:#00a8c8">byte</span>
</span></span></code></pre></div><p>So our cardinality is:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>byte * byte
</span></span><span style="display:flex;"><span>256 * 256
</span></span><span style="display:flex;"><span>65536
</span></span></code></pre></div><p>Few illegal states here&hellip;</p>
<h3 id="correct-implementation">Correct implementation</h3>
<p>Let try another model.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Player</span> <span style="color:#f92672">=</span> <span style="color:#111">Serving</span> <span style="color:#f92672">|</span> <span style="color:#111">Opponent</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Point</span> <span style="color:#f92672">=</span> <span style="color:#111">Love</span> <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span> <span style="color:#f92672">|</span> <span style="color:#111">Forty</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Score</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Point</span> <span style="color:#f92672">*</span> <span style="color:#111">Point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Player</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Game</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Player</span>
</span></span></code></pre></div><p>Our model has a better look new, and we&rsquo;re even finding some of our business semantic. Let&rsquo;s compute our cardinality.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>type Player = 2 
</span></span><span style="display:flex;"><span>type Point = 4
</span></span><span style="display:flex;"><span>type Score =
</span></span><span style="display:flex;"><span>    | Points = 4 * 4
</span></span><span style="display:flex;"><span>    | Advantage = 2
</span></span><span style="display:flex;"><span>    | Game = 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>type Score = 4 * 4 + 2 + 2
</span></span><span style="display:flex;"><span>type Score = 20
</span></span></code></pre></div><p>Our cardinality is correct, we can&rsquo;t produce illegal states. If we implement our rules, it looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">computeScore</span> <span style="color:#f92672">(</span><span style="color:#111">currentScore</span><span style="color:#f92672">:</span> <span style="color:#111">Score</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span><span style="color:#111">pointTo</span><span style="color:#f92672">:</span> <span style="color:#111">Player</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">let</span> <span style="color:#111">addPoint</span> <span style="color:#111">point</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#00a8c8">match</span> <span style="color:#111">point</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#111">Love</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Fifteen</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Thrity</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Forty</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">currentScore</span><span style="color:#f92672">,</span> <span style="color:#111">pointTo</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#00a8c8">when</span> <span style="color:#111">player</span> <span style="color:#f92672">=</span> <span style="color:#111">pointTo</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">player</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#f92672">_,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">Forty</span><span style="color:#f92672">,</span> <span style="color:#111">Forty</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">Forty</span><span style="color:#f92672">,</span> <span style="color:#111">Forty</span><span style="color:#f92672">),</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Advantage</span> <span style="color:#111">pointTo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">Forty</span><span style="color:#f92672">,</span> <span style="color:#f92672">_),</span> <span style="color:#111">Serving</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">Serving</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(_,</span> <span style="color:#111">Forty</span><span style="color:#f92672">),</span> <span style="color:#111">Opponent</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">Opponent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">),</span> <span style="color:#111">Serving</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">addPoint</span> <span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">),</span> <span style="color:#111">Opponent</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">addPoint</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Game</span> <span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">player</span>
</span></span></code></pre></div><p>The complete code for this implementation is available <a href="tennis-kata-solution-1.fsx">here</a>.</p>
<p>If you&rsquo;re unfamiliar with F#, this is basically a function that takes the current score and the player who won the point, and it returns the new score. The <code>match ... with</code> syntax is kinda like a <code>switch</code> that will return the result associated with the first pattern it matches. For example, for our pair <code>currentScore, pointTo</code>, if we match the pattern <code>Points (Forty, _), Serving</code>, this means the serving player won the point and already had 40 points. Opponent score is not checked (we used the <code>_</code> wildcard) and can be of any value except 40 because it should have been caught by the previous pattern <code>Points (Forty, Forty), _</code>.</p>
<p>This model is rather good. If we treat our function <code>computeScore</code> as a black box, every possible input will have an associated output, there is no unexpected side effect and the code is deterministic. However, if we look closely at the implementation, there are some tensions in our algorithm.</p>
<p>Indeed, the value <code>Forty</code> seems to be special as we have to check for it in our main <code>match</code>. It also forces the order of the patterns to check. In addition, our inner <code>addPoint</code> function can return <code>Forty</code> but never check for it as an input. This is something the compiler warns us about:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>tennis-kata-solution-1.fsx(10,15): warning FS0025: Incomplete pattern matches on this expression.
</span></span><span style="display:flex;"><span>For example, the value &#39;Forty&#39; may indicate a case not covered by the pattern(s).
</span></span></code></pre></div><blockquote>
<p>Tip: This ability to detect incomplete <code>match</code> and to suggest missing cases is a cool feature from the F# compiler. In the company I&rsquo;m working at, we turned this warning as a compilation error for <code>release</code> builds to avoid runtime errors in our production environment. Keeping it as a warning for <code>debug</code> builds is more convenient while developing features.</p>
</blockquote>
<p>We could keep this model and eliminate this warning by removing the <code>addPoint</code> function and getting a more exhaustive pattern in the main <code>match</code>. Though, the <code>Forty</code> value remains a special case.</p>
<h3 id="final-implementation">Final implementation</h3>
<p>Another possibility is to remove <code>Forty</code> from our <code>Point</code> type and introduce new cases to the <code>Score</code> type. We have to make a difference between the &ldquo;40-40&rdquo; aka &ldquo;Deuce&rdquo; and the other combinations. Our new model is now:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Player</span> <span style="color:#f92672">=</span> <span style="color:#111">Serving</span> <span style="color:#f92672">|</span> <span style="color:#111">Opponent</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Point</span> <span style="color:#f92672">=</span> <span style="color:#111">Love</span> <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">Score</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Point</span> <span style="color:#f92672">*</span> <span style="color:#111">Point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Forty</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Player</span> <span style="color:#f92672">*</span> <span style="color:#111">Point</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Deuce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Player</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Game</span> <span style="color:#00a8c8">of</span> <span style="color:#111">Player</span>
</span></span></code></pre></div><p>In the case of the <code>Forty</code>, the <code>Player</code> represents the one who has 40 points, the <code>Point</code> represents the points of the other player.</p>
<p>Once again, let&rsquo;s compute our cardinality.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>type Player = 2 
</span></span><span style="display:flex;"><span>type Point = 3
</span></span><span style="display:flex;"><span>type Score =
</span></span><span style="display:flex;"><span>    | Points = 3 * 3
</span></span><span style="display:flex;"><span>    | Forty = 2 * 3
</span></span><span style="display:flex;"><span>    | Deuce = 1
</span></span><span style="display:flex;"><span>    | Advantage = 2
</span></span><span style="display:flex;"><span>    | Game = 2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>type Score = 3 * 3 + 2 * 3 + 1 + 2 + 2
</span></span><span style="display:flex;"><span>type Score = 9 + 6 + 1 + 2 + 2
</span></span><span style="display:flex;"><span>type Score = 20
</span></span></code></pre></div><p>Great! Our cardinality remains correct, we can now use it and it will drive the code implementation.</p>
<p>First, our <code>addPoint</code> function cannot remain like this: it was taking a <code>Point</code> and returned a <code>Point</code>. Now, if we try to increase <code>Thrity</code>, we have to return the type (not the value) <code>Forty</code>. So our function must evolve in order to return a <code>Score</code> instead of a <code>Point</code>, this means we need points of both players as input. If the serving player marked, the function looks like:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">addPointToServingPlayer</span> <span style="color:#111">pointServingPlayer</span> <span style="color:#111">pointOpponent</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">pointServingPlayer</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Love</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">Fifteen</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">Thrity</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">Serving</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We add another function to handle the case when the opponent player won the point:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">addPointToOpponentPlayer</span> <span style="color:#111">pointServingPlayer</span> <span style="color:#111">pointOpponent</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">pointOpponent</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Love</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">Fifteen</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">Thrity</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">Opponent</span><span style="color:#f92672">,</span> <span style="color:#111">pointServingPlayer</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Then, we now have to handle the <code>Forty</code> type. Once again, we&rsquo;re not only incrementing the opponent&rsquo;s <code>Point</code> value: if the value is <code>Thrity</code>, then next score will be <code>Deuce</code>. Let&rsquo;s add a dedicated function:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">addPointToOtherPlayer</span> <span style="color:#111">fortyPlayer</span> <span style="color:#111">otherPlayerPoint</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">otherPlayerPoint</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Love</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">fortyPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">Fifteen</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Fifteen</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">fortyPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">Thrity</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Thrity</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Deuce</span>
</span></span></code></pre></div><p>Finally, we now have to handle our new types <code>Forty</code> and <code>Deuce</code> in our main <code>match</code> and use our new functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">computeScore</span> <span style="color:#f92672">(</span><span style="color:#111">currentScore</span><span style="color:#f92672">:</span> <span style="color:#111">Score</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span><span style="color:#111">pointTo</span><span style="color:#f92672">:</span> <span style="color:#111">Player</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#00a8c8">match</span> <span style="color:#111">currentScore</span><span style="color:#f92672">,</span> <span style="color:#111">pointTo</span> <span style="color:#00a8c8">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">),</span> <span style="color:#111">Serving</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">addPointToServingPlayer</span> <span style="color:#111">pointServingPlayer</span> <span style="color:#111">pointOpponent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Points</span> <span style="color:#f92672">(</span><span style="color:#111">pointServingPlayer</span><span style="color:#f92672">,</span> <span style="color:#111">pointOpponent</span><span style="color:#f92672">),</span> <span style="color:#111">Opponent</span> <span style="color:#f92672">-&gt;</span>  
</span></span><span style="display:flex;"><span>        <span style="color:#111">addPointToOpponentPlayer</span> <span style="color:#111">pointServingPlayer</span> <span style="color:#111">pointOpponent</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#f92672">_),</span> <span style="color:#f92672">_</span> <span style="color:#00a8c8">when</span> <span style="color:#111">player</span> <span style="color:#f92672">=</span> <span style="color:#111">pointTo</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">player</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Forty</span> <span style="color:#f92672">(</span><span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#111">otherPlayerPoints</span><span style="color:#f92672">),</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#111">addPointToOtherPlayer</span> <span style="color:#111">player</span> <span style="color:#111">otherPlayerPoints</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Deuce</span><span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Advantage</span> <span style="color:#111">pointTo</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#00a8c8">when</span> <span style="color:#111">player</span> <span style="color:#f92672">=</span> <span style="color:#111">pointTo</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">player</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Advantage</span> <span style="color:#f92672">_,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Deuce</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#111">Game</span> <span style="color:#111">player</span><span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#111">Game</span> <span style="color:#111">player</span>
</span></span></code></pre></div><p>The complete code for this implementation is available <a href="tennis-kata-solution-2.fsx">here</a>.</p>
<h2 id="compare-infinites">Compare infinites</h2>
<p>Right now, you may think: &ldquo;That&rsquo;s great, but I can&rsquo;t use it for my software. I&rsquo;m using strings and large numbers. The cardinality will always be infinite.&rdquo; And you&rsquo;re right!</p>
<p>Keep in mind that computing cardinality is useful for an algorithm. There is just no point to compute this value for our whole software. Instead, we have to consider only relevant values in our data. The tennis kata is somehow a special case: the whole model is used by our <code>computeScore</code> function to make a decision. But most of the time, a model carries a lot of data, and only a fraction of it is used by the algorithm.</p>
<p>So, to avoid this infinite issue, I use two tricks to reduce the cardinality to a manageable number:</p>
<p>First, I replace the unused values by our algorithm with a cardinality of 1. Here&rsquo;s an example:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyType</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ValueA</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ValueB</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">myFunction</span> <span style="color:#f92672">(</span><span style="color:#111">x</span><span style="color:#f92672">:</span> <span style="color:#111">MyType</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">ValueA</span>
</span></span></code></pre></div><p>Only the <code>ValueA</code> is used, <code>ValueB</code> has no impact on our function. So we can compute the cardinality of <code>MyType</code> for <code>myFunction</code> like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>type MyType = {
</span></span><span style="display:flex;"><span>    ValueA: bool
</span></span><span style="display:flex;"><span>    ValueB: string // not used by myFunction
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ValueA = 2
</span></span><span style="display:flex;"><span>ValueB = 1
</span></span><span style="display:flex;"><span>type MyType = 2 * 1 = 2
</span></span></code></pre></div><p>Second trick, values can be compared to fulfill some conditions. A typical example is the comparison of IDs, by definition these types have a large cardinality as they usually use types like <code>int</code>, <code>string</code> or <code>UUID</code>. But at the end of the day it is the equality that matter. In such cases, we can reduce the cardinality to two cases: it is either the expected value or not.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#00a8c8">type</span> <span style="color:#75af00">MyType</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">Id</span><span style="color:#f92672">:</span> <span style="color:#111">int</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ValueA</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">bool</span>
</span></span><span style="display:flex;"><span>    <span style="color:#111">ValueB</span><span style="color:#f92672">:</span> <span style="color:#00a8c8">string</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#00a8c8">let</span> <span style="color:#111">isTheExpectedValue</span> <span style="color:#f92672">(</span><span style="color:#111">expectedId</span><span style="color:#f92672">:</span> <span style="color:#111">int</span><span style="color:#f92672">)</span> <span style="color:#f92672">(</span><span style="color:#111">x</span><span style="color:#f92672">:</span> <span style="color:#111">MyType</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#111">x</span><span style="color:#f92672">.</span><span style="color:#111">Id</span> <span style="color:#f92672">=</span> <span style="color:#111">expectedId</span>
</span></span></code></pre></div><p>If we consider <code>expectedId</code>, the value to match, as some kind of constant, then we can reduce the cardinality of <code>Id</code> to two cases: <code>Equals | NotEquals</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-text" data-lang="text"><span style="display:flex;"><span>type MyType = {
</span></span><span style="display:flex;"><span>    Id: int // compare to expectedId
</span></span><span style="display:flex;"><span>    ValueA: bool // not used
</span></span><span style="display:flex;"><span>    ValueB: string // not used
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Id = Equals | NotEquals = 2
</span></span><span style="display:flex;"><span>ValueA = 1
</span></span><span style="display:flex;"><span>ValueB = 1
</span></span><span style="display:flex;"><span>type MyType = 2 * 1 * 1 = 2
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>In this post, we&rsquo;ve learned how to compute the number of possible states for our model. Then we saw how it can drive the implementation. Finally, I&rsquo;ve suggested some tricks to help us compute cardinality for models that are embedding types with a large number of possible values.</p>
<p>Aiming to tackle illegal states is great, though it can also introduce complexity to the code:</p>
<ul>
<li>We haven&rsquo;t really eliminated illegal states, we&rsquo;ve just pushed them out of the domain. This means complex models will also be complex to build from external inputs. We&rsquo;ll have to parse and validate inputs, then map to our domain model.</li>
<li>Sometimes, the model isn&rsquo;t at the correct level of abstraction for some treatments. For example, to access a value, we may find it in several places; Each time we need a new value, we have to write a new function that goes across the whole model. If you want to experience this, with our latest model try to write a function to retrieve the points of the serving player and then another for his opponent.</li>
</ul>
<p>To conclude, type cardinality helps us gain confidence in our model and identify unhandled use cases. If you have an opportunity to remove illegal states, go for it. But keep in mind that allowing some illegal states in order to simplify the development and model manipulation is OK as long as these cases are properly identified and handled.</p>
<hr>
<h2 id="comments">Comments</h2>
<!--Add your comment here-->
<p>Wish to comment? Please, add your comment by <a href="https://github.com/RomainTrm/Blog?tab=readme-ov-file#how-to-comment" target="_blank">sending me a pull request</a>.</p>

        </article>
        
            <div class="tags">
                <span title="Tags">üè∑</span>
                <div class="horizontal-links links">
                    <a href="/tags/post/">Post</a><a href="/tags/en/">En</a>
                </div>
            </div>
        
    </article>


    </main>
    <footer>
  <div class="content-container">
    <div class="content"><div class="about">
  <h2>Romain Berthon</h2>
  Software developer, *DD and F# enthusiast

  
    <p class="horizontal-links"><a href="https://github.com/RomainTrm"
         target="_blank" 
        
        >Github</a><a href="https://bsky.app/profile/berthon.dev"
         target="_blank" 
        
        >Bsky</a><a href="https://fr.linkedin.com/in/romain-berthon-254977101"
         target="_blank" 
        
        >LinkedIn</a></p>
  
</div>
</div>
  </div>
</footer>
    </body>
</html>
