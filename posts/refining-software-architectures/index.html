<!doctype html><html><meta charset=utf-8><meta http-equiv=Content-Security-Policy content="default-src 'none'; script-src 'none'; style-src 'self' 'sha256-hevimW2qBMcsaZR62OkETyNJKvnMSjRYOz6kIyvEFtg='; img-src 'self'; connect-src 'self'; base-uri 'self'; manifest-src 'self'; media-src 'self'"><meta http-equiv=Strict-Transport-Security content="max-age=63072000; includeSubDomains; preload"><meta http-equiv=X-Content-Type-Options content="nosniff"><meta http-equiv=Referrer-Policy content="strict-origin-when-cross-origin"><meta name=viewport content="width=device-width,initial-scale=1"><title>Refining software architectures · Romain Berthon</title>
<link rel=stylesheet href=/css/rocinante.css><link rel="shortcut icon" href=https://berthon.dev//favicon.ico><body><header><nav><a class=home href=https://berthon.dev/>‹ Home</a><div></div><div><a href=https://berthon.dev//tags/post>Posts</a>
<a href=https://berthon.dev//tags/talk>Talks</a>
<a href=https://berthon.dev//about>About</a></div></nav></header><main><div class=post><div class=title-group><div class=title><h1>Refining software architectures</h1></div><div class=date><h5>Mar 12, 2025</h5></div></div><article class=content><p>To develop software, as developers we have to choose between several architectures. Our choice must be based on various constraints like the type of problem we&rsquo;re trying to solve, but also the load or the level of reliability and resiliency targeted. We also have to consider the available skills in the team.</p><p>In this blog post, I want to iterate through several back-end architectures I&rsquo;ve encountered and used during my career. For each of them, I&rsquo;ll be highlighting their limitations and then introducing an improvement. To do so, I&rsquo;ll start from the (in)famous &ldquo;CRUD app&rdquo;, the assumed simplest architecture, the one that will not give you one of your worst headache (until it does), and I&rsquo;ll finish with some advanced solutions.</p><h2 id=defining-crud>Defining CRUD</h2><p>First thing first, what does <em>CRUD</em> means? This is the acronym for <strong>C</strong>reate, <strong>R</strong>ead, <strong>U</strong>pdate and <strong>D</strong>elete. These are the four basic operations to manipulate data in a database. Sometimes you&rsquo;ll also find a fifth verb which is <strong>S</strong>earch, but to me it falls within the <strong>R</strong>ead concerns.</p><p>So, if we try to define in a strict and naive way a &ldquo;CRUD application&rdquo;, this is basically a form that manipulates raw data from the database without any other form of business logic. Such solution may fit if our only concern is about storing and accessing the data.</p><p>Having an application that just mimic the database schema is so trivial that many off-the-shelf solutions exist. I can think of <a href=https://www.adminer.org/ target=_blank>Adminer</a> that provides you a web interface, or code generators (like <a href=https://www.jhipster.tech/ target=_blank>JHipster</a>) that generates REST API on top of the database. These are easy to use solutions that can be implemented in a few hours without any specific skills.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 544 89"><g transform="translate(8,16)"><path d="M0 0H160" fill="none" stroke="currentcolor"/><path d="M0 32H8" fill="none" stroke="currentcolor"/><path d="M24 32h8" fill="none" stroke="currentcolor"/><path d="M40 32h8" fill="none" stroke="currentcolor"/><path d="M56 32h8" fill="none" stroke="currentcolor"/><path d="M72 32h8" fill="none" stroke="currentcolor"/><path d="M88 32h8" fill="none" stroke="currentcolor"/><path d="M104 32h8" fill="none" stroke="currentcolor"/><path d="M120 32h8" fill="none" stroke="currentcolor"/><path d="M136 32h8" fill="none" stroke="currentcolor"/><path d="M152 32h8" fill="none" stroke="currentcolor"/><path d="M0 64H72" fill="none" stroke="currentcolor"/><path d="M72 64h88" fill="none" stroke="currentcolor"/><path d="M0 0V32" fill="none" stroke="currentcolor"/><path d="M0 32V64" fill="none" stroke="currentcolor"/><path d="M160 0V32" fill="none" stroke="currentcolor"/><path d="M160 32V64" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="16" y="52" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="40" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">r</text></g></svg></div><p>Even if we can think of some valid use cases, those are rare. Let&rsquo;s face it! No one is paying a team of developers to only build a <em>CRUD</em> application, this is way too trivial to justify such a financial expense. There is always at least some validations/business rules on top of it.</p><h2 id=making-useful-software-adding-logic>Making useful software: adding logic</h2><p>If I try to redefine our &ldquo;CRUD application&rdquo; with a broader definition: it&rsquo;s an application with a central data model and some business rules upon it. Now we have some reasons to hire a developer!</p><p>Basically, we want to add an intermediate layer between our form and the database, this layer will handle the business logic. This is the emergence of a layered architecture.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 560 249"><g transform="translate(8,16)"><path d="M0 0H160" fill="none" stroke="currentcolor"/><path d="M0 32H72" fill="none" stroke="currentcolor"/><path d="M72 32h88" fill="none" stroke="currentcolor"/><path d="M0 80H160" fill="none" stroke="currentcolor"/><path d="M0 112H72" fill="none" stroke="currentcolor"/><path d="M72 112h88" fill="none" stroke="currentcolor"/><path d="M0 160H160" fill="none" stroke="currentcolor"/><path d="M0 192H160" fill="none" stroke="currentcolor"/><path d="M0 224H24" fill="none" stroke="currentcolor"/><path d="M0 0V32" fill="none" stroke="currentcolor"/><path d="M0 80v32" fill="none" stroke="currentcolor"/><path d="M0 160v32" fill="none" stroke="currentcolor"/><path d="M72 32V64" fill="none" stroke="currentcolor"/><path d="M72 112v32" fill="none" stroke="currentcolor"/><path d="M160 0V32" fill="none" stroke="currentcolor"/><path d="M160 80v32" fill="none" stroke="currentcolor"/><path d="M160 160v32" fill="none" stroke="currentcolor"/><polygon points="32.000000,224.000000 20.000000,218.399994 20.000000,229.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 224.000000)"/><path d="M72 64v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,64.000000 76.000000,58.400002 76.000000,69.599998" fill="currentcolor" transform="rotate(90.000000, 72.000000, 64.000000)"/><path d="M72 144v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,144.000000 76.000000,138.399994 76.000000,149.600006" fill="currentcolor" transform="rotate(90.000000, 72.000000, 144.000000)"/><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="16" y="180" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="32" y="100" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="32" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="40" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="40" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="40" y="228" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="48" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="228" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="228" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="104" y="228" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="128" y="180" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="180" fill="currentcolor" style="font-size:1em">r</text></g></svg></div><p>This architecture allows some new capabilities.</p><p>First, we now have a dedicated space in our code where we can develop business logic. The most basic way to use it is to receive input from the <em>Application layer</em>, load some data from the <em>Data access layer</em>, then make a decision and update the data. Here&rsquo;s a pseudo-code example:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>data</span> <span style=color:#111>=</span> <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// apply some logic based on data and value</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>&amp;&amp;</span> <span style=color:#111>data</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>=</span> <span style=color:#00a8c8>value</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>Secondly, it reduces the coupling to the data model for the consumer. In the &ldquo;pure CRUD application&rdquo; solution, our data model was leaking to the outside world and clients had to conform to this model to manipulate the data. This is an issue because if we decide to change our data model, it will break our consumers. Now, we can expose some behaviors and abstractions and keep our data model internal (like in the previous code example). It can be beneficial for commands because we&rsquo;re now exposing only relevant fields for each use case and not the entire model.</p><p>Finally, we can also choose to introduce a <em>rich model</em>: until now we were manipulating an <em>anemic model</em>. An <em>anemic model</em> is a basic POXO (like <em>Plain Old Java Object</em> or <em>Plain Old C# Object</em>) that only carries the data. This is often the data model stored in the database. We have to use a <em>service</em> to apply business rules (mutations) to this POXO. This separation between data and behavior is not an issue by itself, it&rsquo;s even very common in <em>functional programming</em>. The problem is that our business logic conform and works with the storage data model that may not fit well with business constraints. With a <em>rich model</em>, we&rsquo;re introducing a new model that is designed to fit with the business, that can possibly enforce some rules with strong typing and may regroup data and behaviors in the same place. Yes, it requires some two-direction mapping logic between these two models but this is a fair tradeoff.</p><h2 id=driving-by-business-growing-in-complexity>Driving by business: growing in complexity</h2><p>Until now, our architecture remained <em>data-centric</em>. What I mean here is that is we draw an arrow to represent the data flow, we&rsquo;ll realize that our data model is in the center of our application.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 616 313"><g transform="translate(8,16)"><path d="M0 32H32" fill="none" stroke="currentcolor"/><path d="M48 32h64" fill="none" stroke="currentcolor"/><path d="M128 32h32" fill="none" stroke="currentcolor"/><path d="M0 64H32" fill="none" stroke="currentcolor"/><path d="M48 64H72" fill="none" stroke="currentcolor"/><path d="M72 64h40" fill="none" stroke="currentcolor"/><path d="M128 64h32" fill="none" stroke="currentcolor"/><path d="M304 64H568" fill="none" stroke="currentcolor"/><path d="M336 96H536" fill="none" stroke="currentcolor"/><path d="M0 112H32" fill="none" stroke="currentcolor"/><path d="M48 112h64" fill="none" stroke="currentcolor"/><path d="M128 112h32" fill="none" stroke="currentcolor"/><path d="M368 128H504" fill="none" stroke="currentcolor"/><path d="M0 144H32" fill="none" stroke="currentcolor"/><path d="M48 144H72" fill="none" stroke="currentcolor"/><path d="M72 144h40" fill="none" stroke="currentcolor"/><path d="M128 144h32" fill="none" stroke="currentcolor"/><path d="M272 160H6e2" fill="none" stroke="currentcolor"/><path d="M0 192H32" fill="none" stroke="currentcolor"/><path d="M48 192h64" fill="none" stroke="currentcolor"/><path d="M128 192h32" fill="none" stroke="currentcolor"/><path d="M368 192H504" fill="none" stroke="currentcolor"/><path d="M336 208H536" fill="none" stroke="currentcolor"/><path d="M0 224H32" fill="none" stroke="currentcolor"/><path d="M48 224H72" fill="none" stroke="currentcolor"/><path d="M72 224h40" fill="none" stroke="currentcolor"/><path d="M128 224h32" fill="none" stroke="currentcolor"/><path d="M304 224H568" fill="none" stroke="currentcolor"/><path d="M56 240h48" fill="none" stroke="currentcolor"/><path d="M0 272H24" fill="none" stroke="currentcolor"/><path d="M0 288H24" fill="none" stroke="currentcolor"/><path d="M0 32V64" fill="none" stroke="currentcolor"/><path d="M0 112v32" fill="none" stroke="currentcolor"/><path d="M0 192v32" fill="none" stroke="currentcolor"/><path d="M40 16V224" fill="none" stroke="currentcolor"/><path d="M72 64V96" fill="none" stroke="currentcolor"/><path d="M72 144v32" fill="none" stroke="currentcolor"/><path d="M120 16V224" fill="none" stroke="currentcolor"/><path d="M160 32V64" fill="none" stroke="currentcolor"/><path d="M160 112v32" fill="none" stroke="currentcolor"/><path d="M160 192v32" fill="none" stroke="currentcolor"/><path d="M288 80v48" fill="none" stroke="currentcolor"/><path d="M288 176v32" fill="none" stroke="currentcolor"/><path d="M320 112v16" fill="none" stroke="currentcolor"/><path d="M320 176v16" fill="none" stroke="currentcolor"/><path d="M552 112v32" fill="none" stroke="currentcolor"/><path d="M552 176v16" fill="none" stroke="currentcolor"/><path d="M584 80v64" fill="none" stroke="currentcolor"/><path d="M584 176v32" fill="none" stroke="currentcolor"/><path d="M288 168v8" fill="none" stroke="currentcolor"/><path d="M320 168v8" fill="none" stroke="currentcolor"/><path d="M352 144v8" fill="none" stroke="currentcolor"/><path d="M352 168v8" fill="none" stroke="currentcolor"/><path d="M520 144v8" fill="none" stroke="currentcolor"/><path d="M520 168v8" fill="none" stroke="currentcolor"/><path d="M552 144v8" fill="none" stroke="currentcolor"/><path d="M552 168v8" fill="none" stroke="currentcolor"/><path d="M584 144v8" fill="none" stroke="currentcolor"/><path d="M584 168v8" fill="none" stroke="currentcolor"/><polygon points="32.000000,272.000000 20.000000,266.399994 20.000000,277.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 272.000000)"/><polygon points="32.000000,288.000000 20.000000,282.399994 20.000000,293.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 288.000000)"/><path d="M72 96v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,96.000000 76.000000,90.400002 76.000000,101.599998" fill="currentcolor" transform="rotate(90.000000, 72.000000, 96.000000)"/><path d="M72 176v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,176.000000 76.000000,170.399994 76.000000,181.600006" fill="currentcolor" transform="rotate(90.000000, 72.000000, 176.000000)"/><polygon points="128.000000,16.000000 116.000000,10.400000 116.000000,21.600000" fill="currentcolor" transform="rotate(270.000000, 120.000000, 16.000000)"/><polygon points="608.000000,160.000000 596.000000,154.399994 596.000000,165.600006" fill="currentcolor" transform="rotate(0.000000, 600.000000, 160.000000)"/><path d="M304 64A16 16 0 00288 80" fill="none" stroke="currentcolor"/><path d="M568 64a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M336 96a16 16 0 00-16 16" fill="none" stroke="currentcolor"/><path d="M536 96a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M368 128a16 16 0 00-16 16" fill="none" stroke="currentcolor"/><path d="M504 128a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M352 176a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M520 176a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M320 192a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M552 192a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M288 208a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M584 208a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M40 224a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M120 224a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><circle cx="0" cy="288" r="6" stroke="currentcolor" fill="#fff"/><circle cx="40" cy="16" r="6" stroke="currentcolor" fill="#fff"/><circle cx="272" cy="160" r="6" stroke="currentcolor" fill="#fff"/><text text-anchor="middle" x="16" y="52" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="16" y="212" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="24" y="52" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="52" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="32" y="132" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="32" y="212" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="276" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="40" y="292" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="132" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="48" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="292" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="56" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="276" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="56" y="292" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="292" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="276" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="292" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="80" y="292" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="292" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="132" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="292" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="104" y="4" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="104" y="132" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="104" y="276" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="52" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="212" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="276" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="128" y="52" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="128" y="212" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="52" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="148" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="288" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="296" y="36" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="296" y="148" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="304" y="36" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="304" y="148" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="312" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="312" y="148" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="320" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="148" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="328" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="328" y="148" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="336" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="336" y="148" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="344" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="352" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="360" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="368" y="36" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="376" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="376" y="84" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="376" y="148" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="384" y="84" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="384" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="392" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="392" y="84" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="392" y="116" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="392" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="400" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="400" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="400" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="400" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="408" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="408" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="408" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="416" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="416" y="84" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="416" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="416" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="424" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="424" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="424" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="424" y="148" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="432" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="432" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="432" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="432" y="148" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="440" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="440" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="440" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="448" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="448" y="84" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="448" y="148" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="456" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="456" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="456" y="148" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="464" y="36" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="472" y="84" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="148" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="480" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="480" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="480" y="148" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="488" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="488" y="84" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="488" y="148" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="496" y="36" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="496" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="496" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="504" y="36" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="504" y="84" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="504" y="148" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="512" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="520" y="36" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="528" y="36" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="536" y="36" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="544" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="552" y="36" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="560" y="36" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="568" y="36" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="576" y="36" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="584" y="36" fill="currentcolor" style="font-size:1em">n</text></g></svg></div><p>This was OK, but now our users are asking for new cool features that will introduce more complexity to our software, models will grow and we will have to heavily rely on automated tests to ensure there is no regression. This is where I think this <em>layered architecture</em> shows its limits.</p><h3 id=testability>Testability</h3><p>Let&rsquo;s address testability first. The layers are already testable but with a huge constraint: the higher is the layer we want to test, the more layers to include in our test. This means to test our <em>Domain layer</em>, where sits all our business logic (the main thing to test), we have to always include the <em>Data access layer</em> because we&rsquo;re depending on it. That is painful for several reasons: we have to set up data in the database to run a business test, this adds useless complexity and noise to the tests. This is even worse if the <em>Data access layer</em> is using an ORM that is mapping foreign keys as objects, in such case we may manipulate a complete object tree. Also, tests relying on the database are slower and more prone to side-effects (concurrent tests on the same model).</p><p>The simplest move I see there is called the <em>&ldquo;sandwich pattern&rdquo;</em>. The idea is, inside the <em>Domain layer</em>, to split data access logic from business logic. This way, we&rsquo;ll be able to test our logic without worrying about other concerns. But if we also want to test this data access logic, we fallback to our tests with data set up in the database. If I apply this pattern to our previous pseudo-code example:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// Isolated and easy to test logic</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>&amp;&amp;</span> <span style=color:#111>data</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#111>data</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>=</span> <span style=color:#00a8c8>value</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Function called by the Application layer</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Data access logic</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>data</span> <span style=color:#111>=</span> <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Business logic</span>
</span></span><span style=display:flex><span>  <span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Data access logic</span>
</span></span><span style=display:flex><span>  <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>This pattern is called <em>&ldquo;sandwich&rdquo;</em> because a business logic slice is surrounded by two data access slices, like the ham between two slices of bread. I would now advise reworking this <code>void businessLogic(data, value)</code> method to make it pure (and even easier to test because it&rsquo;s deterministic) instead of mutating the <code>data</code> input.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#111>Data</span> <span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>&amp;&amp;</span> <span style=color:#111>data</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#111>{...</span><span style=color:#111>data</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>return</span> <span style=color:#111>data</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>data</span> <span style=color:#111>=</span> <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>updatedData</span> <span style=color:#111>=</span> <span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#111>data</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>updatedData</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>And <em>voilà</em>! We&rsquo;ve implemented a new architecture pattern called <a href=https://kennethlange.com/functional-core-imperative-shell/ target=_blank><em>Functional core, Imperative shell</em></a>. In our previous example, the <em>functional core</em> is our <code>businessLogic</code> function, it&rsquo;s surrounded by the <em>imperative shell</em> defined by the <code>domainLayerFunction</code> method.</p><h3 id=domain-centric>Domain centric</h3><p>The <em>sandwich</em> trick is great but the architecture still remains <em>data-centric</em>. I want to go further!</p><p>In my previous code example, I used an <em>anemic model</em> defined by the database schema. If I want to introduce my <em>rich model</em>, I must define the mapping inside the <em>Domain layer</em>: <em>Domain layer</em> defines the <em>rich model</em>, and depends on the <em>Data access layer</em>. So <em>Data access layer</em> is unaware of the <em>rich model</em> and then cannot do the mapping.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>dbModel</span> <span style=color:#111>=</span> <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>richModel</span> <span style=color:#111>=</span> <span style=color:#111>mapToRichModel</span><span style=color:#111>(</span><span style=color:#111>dbModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>updatedRichModel</span> <span style=color:#111>=</span> <span style=color:#111>richModel</span><span style=color:#111>.</span><span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>updatedDataModel</span> <span style=color:#111>=</span> <span style=color:#111>mapToDataModel</span><span style=color:#111>(</span><span style=color:#111>updatedRichModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>updatedDataModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>There&rsquo;s an alternative way to reduce this mapping problem: we can bring out commands on the <em>Data access layer</em>. In the following example, it takes the form of a specialized function to update data, <code>dataLayer.updateValue(id, updatedRichModel.value)</code>.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>dbModel</span> <span style=color:#111>=</span> <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>richModel</span> <span style=color:#111>=</span> <span style=color:#111>mapToRichModel</span><span style=color:#111>(</span><span style=color:#111>dbModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>var</span> <span style=color:#111>updatedRichModel</span> <span style=color:#111>=</span> <span style=color:#111>richModel</span><span style=color:#111>.</span><span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>dataLayer</span><span style=color:#111>.</span><span style=color:#111>updateValue</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#111>updatedRichModel</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>If we choose to go this way, this is a very strong signal that we want to drive our <em>data layer</em> by the business. In our <em>Domain layer</em>, we no longer want to be constraints and even aware of the data model anymore. For now we have to rebuild a valid and complete object/tree in order to persist our business operation (unless we make the commands emerge on the <em>Data access layer</em>). So it&rsquo;s time to introduce a new trick: the <a href=https://en.wikipedia.org/wiki/Dependency_inversion_principle target=_blank><em>dependency inversion</em></a> (the <strong>D</strong> in <a href=https://en.wikipedia.org/wiki/SOLID target=_blank>SOLID</a>). This is a straightforward technique. Instead of a direct call to a dependency, we&rsquo;re defining a contract (often it&rsquo;s an <code>interface</code>) that the dependency must fulfill. Then we got it injected and make the calls through the contract. In our case, we want the <em>Domain layer</em> to define the contract and the <em>Data access layer</em> to implement it:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>interface</span> <span style=color:#75af00>DataAccess</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>RichModel</span> <span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>richModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>DomainService</span><span style=color:#111>(</span><span style=color:#111>DataAccess</span> <span style=color:#111>dataAccess</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>domainLayerFunction</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#111>richModel</span> <span style=color:#111>=</span> <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>dataAccess</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#111>updatedRichModel</span> <span style=color:#111>=</span> <span style=color:#111>richModel</span><span style=color:#111>.</span><span style=color:#111>businessLogic</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>dataAccess</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>updatedRichModel</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>From the testability point of view, it gets way easier to test the data access logic as we can replace the dependency with any kind of <em>test double</em> (<em>spy</em>, <em>stub</em>, <em>fake</em> or whatever pattern you need) to set up our test case. Even if it&rsquo;s not our goal here, it&rsquo;s worth mentioning that this dependency swap is also possible with production implementations, and it allows us to delay some decision-making like &ldquo;Which database should we use to store our data?&rdquo;.</p><p>You may have noticed we&rsquo;re not using nor mapping the data model anymore. Thanks to this technique, we&rsquo;ve reversed the dependency between the <em>Domain layer</em> and the <em>Data access layer</em>. <em>Data access</em> now knows about our <em>rich model</em> and can map it from its own model. We finally have a <em>domain centric</em> architecture!</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 824 297"><g transform="translate(8,16)"><path d="M0 0H160" fill="none" stroke="currentcolor"/><path d="M0 32H72" fill="none" stroke="currentcolor"/><path d="M72 32h88" fill="none" stroke="currentcolor"/><path d="M472 48H776" fill="none" stroke="currentcolor"/><path d="M504 80H744" fill="none" stroke="currentcolor"/><path d="M0 96H160" fill="none" stroke="currentcolor"/><path d="M552 112h8" fill="none" stroke="currentcolor"/><path d="M568 112h8" fill="none" stroke="currentcolor"/><path d="M584 112h8" fill="none" stroke="currentcolor"/><path d="M6e2 112h8" fill="none" stroke="currentcolor"/><path d="M616 112h8" fill="none" stroke="currentcolor"/><path d="M632 112h8" fill="none" stroke="currentcolor"/><path d="M648 112h8" fill="none" stroke="currentcolor"/><path d="M664 112h8" fill="none" stroke="currentcolor"/><path d="M680 112h8" fill="none" stroke="currentcolor"/><path d="M696 112h8" fill="none" stroke="currentcolor"/><path d="M0 128H160" fill="none" stroke="currentcolor"/><path d="M440 144H808" fill="none" stroke="currentcolor"/><path d="M552 176h8" fill="none" stroke="currentcolor"/><path d="M568 176h8" fill="none" stroke="currentcolor"/><path d="M584 176h8" fill="none" stroke="currentcolor"/><path d="M6e2 176h8" fill="none" stroke="currentcolor"/><path d="M616 176h8" fill="none" stroke="currentcolor"/><path d="M632 176h8" fill="none" stroke="currentcolor"/><path d="M648 176h8" fill="none" stroke="currentcolor"/><path d="M664 176h8" fill="none" stroke="currentcolor"/><path d="M680 176h8" fill="none" stroke="currentcolor"/><path d="M696 176h8" fill="none" stroke="currentcolor"/><path d="M0 192H72" fill="none" stroke="currentcolor"/><path d="M72 192h88" fill="none" stroke="currentcolor"/><path d="M504 192H744" fill="none" stroke="currentcolor"/><path d="M472 208H776" fill="none" stroke="currentcolor"/><path d="M0 224H160" fill="none" stroke="currentcolor"/><path d="M0 256H24" fill="none" stroke="currentcolor"/><path d="M0 272H24" fill="none" stroke="currentcolor"/><path d="M0 0V32" fill="none" stroke="currentcolor"/><path d="M0 96v32" fill="none" stroke="currentcolor"/><path d="M0 192v32" fill="none" stroke="currentcolor"/><path d="M72 32V80" fill="none" stroke="currentcolor"/><path d="M72 144v48" fill="none" stroke="currentcolor"/><path d="M160 0V32" fill="none" stroke="currentcolor"/><path d="M160 96v32" fill="none" stroke="currentcolor"/><path d="M160 192v32" fill="none" stroke="currentcolor"/><path d="M456 64v48" fill="none" stroke="currentcolor"/><path d="M456 160v32" fill="none" stroke="currentcolor"/><path d="M488 96v16" fill="none" stroke="currentcolor"/><path d="M488 160v16" fill="none" stroke="currentcolor"/><path d="M760 96v32" fill="none" stroke="currentcolor"/><path d="M760 160v16" fill="none" stroke="currentcolor"/><path d="M792 64v64" fill="none" stroke="currentcolor"/><path d="M792 160v32" fill="none" stroke="currentcolor"/><path d="M456 152v8" fill="none" stroke="currentcolor"/><path d="M488 152v8" fill="none" stroke="currentcolor"/><path d="M520 128v8" fill="none" stroke="currentcolor"/><path d="M520 152v8" fill="none" stroke="currentcolor"/><path d="M728 128v8" fill="none" stroke="currentcolor"/><path d="M728 152v8" fill="none" stroke="currentcolor"/><path d="M760 128v8" fill="none" stroke="currentcolor"/><path d="M760 152v8" fill="none" stroke="currentcolor"/><path d="M792 128v8" fill="none" stroke="currentcolor"/><path d="M792 152v8" fill="none" stroke="currentcolor"/><polygon points="32.000000,256.000000 20.000000,250.399994 20.000000,261.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 256.000000)"/><polygon points="32.000000,272.000000 20.000000,266.399994 20.000000,277.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 272.000000)"/><path d="M72 80v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,80.000000 76.000000,74.400002 76.000000,85.599998" fill="currentcolor" transform="rotate(90.000000, 72.000000, 80.000000)"/><path d="M72 136v8" fill="none" stroke="currentcolor"/><polygon points="88.000000,144.000000 76.000000,138.399994 76.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 72.000000, 144.000000)"/><polygon points="816.000000,144.000000 804.000000,138.399994 804.000000,149.600006" fill="currentcolor" transform="rotate(0.000000, 808.000000, 144.000000)"/><path d="M472 48A16 16 0 00456 64" fill="none" stroke="currentcolor"/><path d="M776 48a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M504 80A16 16 0 00488 96" fill="none" stroke="currentcolor"/><path d="M744 80a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M536 112a16 16 0 00-16 16" fill="none" stroke="currentcolor"/><path d="M712 112a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M520 160a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M728 160a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M488 176a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M760 176a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><path d="M456 192a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M792 192a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><circle cx="0" cy="272" r="6" stroke="currentcolor" fill="#fff"/><circle cx="440" cy="144" r="6" stroke="currentcolor" fill="#fff"/><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="16" y="212" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="24" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="32" y="116" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="32" y="212" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="40" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="40" y="260" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="40" y="276" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="48" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="276" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="56" y="276" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="276" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="276" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="80" y="68" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="80" y="164" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="80" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="260" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="80" y="276" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="88" y="164" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="88" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="276" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="68" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="96" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="96" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="276" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="104" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="104" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="104" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="112" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="212" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="120" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="120" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="120" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="128" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="128" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="128" y="212" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="136" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="144" y="68" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="144" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="144" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="152" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="168" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="192" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="200" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="208" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="164" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="232" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="240" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="240" y="164" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="248" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="248" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="68" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="256" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="264" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="264" y="164" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="272" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="272" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="280" y="68" fill="currentcolor" style="font-size:1em">'</text><text text-anchor="middle" x="288" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="304" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="312" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="68" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="320" y="164" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="328" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="328" y="164" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="336" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="336" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="344" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="344" y="164" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="352" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="352" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="360" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="360" y="164" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="368" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="376" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="384" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="392" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="400" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="408" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="416" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="448" y="132" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="456" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="464" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="472" y="132" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="480" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="488" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="496" y="68" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="496" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="504" y="68" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="504" y="100" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="504" y="132" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="512" y="68" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="512" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="520" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="520" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="528" y="20" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="528" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="528" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="536" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="536" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="536" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="536" y="132" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="544" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="544" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="544" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="544" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="552" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="552" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="552" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="560" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="560" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="560" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="560" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="568" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="568" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="568" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="576" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="576" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="576" y="100" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="576" y="132" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="584" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="584" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="584" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="592" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="592" y="68" fill="currentcolor" style="font-size:1em">&amp;</text><text text-anchor="middle" x="592" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="592" y="132" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="600" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="600" y="68" fill="currentcolor" style="font-size:1em">&amp;</text><text text-anchor="middle" x="600" y="132" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="608" y="100" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="608" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="616" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="616" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="616" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="624" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="624" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="624" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="624" y="132" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="632" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="632" y="68" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="632" y="100" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="632" y="132" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="640" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="640" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="640" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="640" y="132" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="648" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="648" y="100" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="648" y="132" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="656" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="656" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="656" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="656" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="664" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="664" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="664" y="100" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="664" y="132" fill="currentcolor" style="font-size:1em">.</text><text text-anchor="middle" x="672" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="672" y="68" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="672" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="680" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="680" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="680" y="100" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="680" y="132" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="688" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="688" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="688" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="688" y="132" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="696" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="696" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="696" y="132" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="704" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="704" y="100" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="704" y="132" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="712" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="712" y="68" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="712" y="100" fill="currentcolor" style="font-size:1em">h</text><text text-anchor="middle" x="712" y="132" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="720" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="720" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="720" y="100" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="728" y="68" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="728" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="736" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="736" y="100" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="744" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="744" y="100" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="752" y="68" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><blockquote><p>This structure is one of the recommended approaches highlighted by the paper &ldquo;<a href=https://curtclifton.net/papers/MoseleyMarks06a.pdf target=_blank>Out of the Tar Pit</a>&rdquo;. It states that side-effects should be pushed to the boundaries of the system, the domain should be pure (side-effect free), and to connect those two parts there is an intermediate layer (our service).</p></blockquote><p>Now, we&rsquo;re driving our design by the <em>Domain</em>. We can define, code and test our <em>rich model</em> without worrying about data persistence. Once done, we can move on and focus on implementing dependencies and their specific constraints.</p><p>This is the core concept behind a whole family of architectures: <a href=https://en.wikipedia.org/wiki/Hexagonal_architecture_%28software%29 target=_blank><em>hexagonal architecture</em></a> (aka <em>ports and adapters</em>), <em>onion architecture</em> and <em>clean architecture</em>. I will not take the time here to explain the differences between them, mostly because I tend to see them as <a href=https://en.wiktionary.org/wiki/bikeshedding target=_blank>bikeshedding</a>.</p><h2 id=data-consistency-should-we-refuse-inputs>Data consistency: should we refuse inputs?</h2><p>I&rsquo;m doing a small interlude here on our architectures refinement to talk about data consistency. On the first versions we&rsquo;ve explored, the <em>data model</em> was central and therefore was carrying a huge responsibility on data consistency. This takes the form of several database mechanics like <em>foreign keys</em> and constraints like <code>NOT NULL</code> or <code>UNIQUE</code>. Now, we&rsquo;ve got a strong <em>domain model</em> responsible for business rules, we may consider more supple rules on the database side. Here&rsquo;s my point: should we refuse a command from the user because our <em>data model</em> says the operation is inconsistent? This question may seem weird, but sometimes there are good reasons to accept an input and assume our system is out of sync with reality. Here are two use cases:</p><p>A few years ago, I was on a trip and I had few troubles on a connection between two flights. That day, the weather was bad, a lot of clouds and dense fog, which resulted in many delayed flights. My first plane landed late and we were rushing to catch our second flight. After a long run through the airport, we managed to arrive at the gate right on time, but our boarding passes were refused by the system, we didn&rsquo;t get onboard. Indeed the system had determined before the onboarding that we couldn&rsquo;t get there on time, so it automatically registered us in a flight later in the day. I don&rsquo;t know if the system reused our seats for other people, but if it didn&rsquo;t, this is a case where the system was out of sync with reality and have blocked users. Yet, our boarding passes could have been a good proof that we were there, ready to get on the plane.</p><p>Now let&rsquo;s imagine we&rsquo;re working on a warehouse. Items are brought in, moved, stored on shelves and then loaded in trucks for delivery. To track items, each of them is marked with unique codes (barcodes, QR codes) that are normally scanned at each step. When loading a truck, we&rsquo;re scanning items until the system detect an inconsistency on one of them because it was supposed to be on a shelf. Do you think the system should prevent us from loading it into the truck? The barcode gives us a high confidence that this is the correct item we&rsquo;re trying to load.</p><p>The way to solve these cases are businesses, not technical decisions. So we should be careful not to build systems that enforce this type of consistency without asking domain experts first.</p><h2 id=distinct-use-cases-commands-and-queries>Distinct use cases: commands and queries</h2><p>Our previous architecture is already pretty good, I think it&rsquo;s even becoming a standard in any team this some good crafting skills, but let&rsquo;s refine it more.</p><p>In most software, reading and writing are not using the same representations of the data. The information displayed to the user is often an aggregation of entities. On the other side, the application of a command is generally more focus on individual entities, and can be easily abstracted with dedicated types containing only revelant values to execute the command. This is an issue as our model is torn by contradictory constraints, getting a model that satisfies both readings and writing will get more and more difficult.</p><p>Also, you may have heard about the <a href=https://en.wikipedia.org/wiki/Pareto_principle target=_blank>Pareto principle</a>: the famous &ldquo;80/20 rule&rdquo;. This is not a rule specific to software, but in the case of management software or e-commerce website, one way to formulate this principle is the read/write ratio: in such software, most accesses are for reading and the writing appears to be less frequent. This means, if we want to improve performances, we can easily target 80% of the use cases just by focusing on readings.</p><p>To address these distinct representation needs and unbalanced load, we can try to make two models emerge, one specialized for reads and the other for writes. In OOP, there&rsquo;s a pattern called <em>CQS</em> (<a href=https://en.wikipedia.org/wiki/Command%E2%80%93query_separation target=_blank><em>Command-Query Separation</em></a>). The core principle is simple: a method on an object is either a <em>Command</em> or a <em>Query</em>. A <em>Command</em> produce a side-effect and is not supposed to return any value, on the opposite, a <em>Query</em> is used to get a value and must not produce any side-effect.</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#75715e>// CQS example</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Counter</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>private</span> <span style=color:#00a8c8>int</span> <span style=color:#00a8c8>value</span> <span style=color:#111>=</span> <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Command: produces a side effect, doesn&#39;t return any value</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>Increment</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>=</span> <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>+</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// Query: return a value, getting the value doesn&#39;t affect the object&#39;s state</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>Get</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>return</span> <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>This pattern has been scaled to the architecture level, this is called <em>CQRS</em> (<a href=https://en.wikipedia.org/wiki/Command_Query_Responsibility_Segregation target=_blank><em>Command and Query Responsibility Segregation</em></a>). We now have a model dedicated to <em>Commands</em> that is responsible for business decisions-making and one model (or more, if justified by the variety of data representations required) dedicated to <em>Queries</em> which only returns data in formats useful for consumers (aka <em>readmodels</em>).</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 456 249"><g transform="translate(8,16)"><path d="M56 0H264" fill="none" stroke="currentcolor"/><path d="M56 32H96" fill="none" stroke="currentcolor"/><path d="M96 32H240" fill="none" stroke="currentcolor"/><path d="M240 32h24" fill="none" stroke="currentcolor"/><path d="M0 48H8" fill="none" stroke="currentcolor"/><path d="M24 48h8" fill="none" stroke="currentcolor"/><path d="M40 48h8" fill="none" stroke="currentcolor"/><path d="M56 48h8" fill="none" stroke="currentcolor"/><path d="M72 48h8" fill="none" stroke="currentcolor"/><path d="M88 48h8" fill="none" stroke="currentcolor"/><path d="M104 48h8" fill="none" stroke="currentcolor"/><path d="M120 48h8" fill="none" stroke="currentcolor"/><path d="M136 48h8" fill="none" stroke="currentcolor"/><path d="M152 48h8" fill="none" stroke="currentcolor"/><path d="M168 48h8" fill="none" stroke="currentcolor"/><path d="M184 48h8" fill="none" stroke="currentcolor"/><path d="M2e2 48h8" fill="none" stroke="currentcolor"/><path d="M216 48h8" fill="none" stroke="currentcolor"/><path d="M232 48h8" fill="none" stroke="currentcolor"/><path d="M248 48h8" fill="none" stroke="currentcolor"/><path d="M264 48h8" fill="none" stroke="currentcolor"/><path d="M280 48h8" fill="none" stroke="currentcolor"/><path d="M296 48h8" fill="none" stroke="currentcolor"/><path d="M312 48h8" fill="none" stroke="currentcolor"/><path d="M40 80H144" fill="none" stroke="currentcolor"/><path d="M40 112H144" fill="none" stroke="currentcolor"/><path d="M0 144H8" fill="none" stroke="currentcolor"/><path d="M24 144h8" fill="none" stroke="currentcolor"/><path d="M40 144h8" fill="none" stroke="currentcolor"/><path d="M56 144h8" fill="none" stroke="currentcolor"/><path d="M72 144h8" fill="none" stroke="currentcolor"/><path d="M88 144h8" fill="none" stroke="currentcolor"/><path d="M104 144h8" fill="none" stroke="currentcolor"/><path d="M120 144h8" fill="none" stroke="currentcolor"/><path d="M136 144h8" fill="none" stroke="currentcolor"/><path d="M152 144h8" fill="none" stroke="currentcolor"/><path d="M168 144h8" fill="none" stroke="currentcolor"/><path d="M184 144h8" fill="none" stroke="currentcolor"/><path d="M2e2 144h8" fill="none" stroke="currentcolor"/><path d="M216 144h8" fill="none" stroke="currentcolor"/><path d="M232 144h8" fill="none" stroke="currentcolor"/><path d="M248 144h8" fill="none" stroke="currentcolor"/><path d="M264 144h8" fill="none" stroke="currentcolor"/><path d="M280 144h8" fill="none" stroke="currentcolor"/><path d="M296 144h8" fill="none" stroke="currentcolor"/><path d="M312 144h8" fill="none" stroke="currentcolor"/><path d="M56 160H96" fill="none" stroke="currentcolor"/><path d="M96 160H240" fill="none" stroke="currentcolor"/><path d="M240 160h24" fill="none" stroke="currentcolor"/><path d="M56 192H264" fill="none" stroke="currentcolor"/><path d="M0 224H24" fill="none" stroke="currentcolor"/><path d="M0 48V64" fill="none" stroke="currentcolor"/><path d="M0 88v16" fill="none" stroke="currentcolor"/><path d="M0 128v16" fill="none" stroke="currentcolor"/><path d="M40 80v32" fill="none" stroke="currentcolor"/><path d="M56 0V32" fill="none" stroke="currentcolor"/><path d="M56 160v32" fill="none" stroke="currentcolor"/><path d="M96 32V64" fill="none" stroke="currentcolor"/><path d="M96 128v32" fill="none" stroke="currentcolor"/><path d="M144 80v32" fill="none" stroke="currentcolor"/><path d="M160 88v16" fill="none" stroke="currentcolor"/><path d="M160 120v16" fill="none" stroke="currentcolor"/><path d="M240 32V144" fill="none" stroke="currentcolor"/><path d="M240 144v16" fill="none" stroke="currentcolor"/><path d="M264 0V32" fill="none" stroke="currentcolor"/><path d="M264 160v32" fill="none" stroke="currentcolor"/><path d="M320 48V64" fill="none" stroke="currentcolor"/><path d="M320 88v16" fill="none" stroke="currentcolor"/><path d="M320 128v16" fill="none" stroke="currentcolor"/><polygon points="32.000000,224.000000 20.000000,218.399994 20.000000,229.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 224.000000)"/><path d="M96 64v8" fill="none" stroke="currentcolor"/><polygon points="112.000000,64.000000 100.000000,58.400002 100.000000,69.599998" fill="currentcolor" transform="rotate(90.000000, 96.000000, 64.000000)"/><path d="M96 120v8" fill="none" stroke="currentcolor"/><polygon points="112.000000,128.000000 100.000000,122.400002 100.000000,133.600006" fill="currentcolor" transform="rotate(270.000000, 96.000000, 128.000000)"/><path d="M240 144v8" fill="none" stroke="currentcolor"/><polygon points="256.000000,144.000000 244.000000,138.399994 244.000000,149.600006" fill="currentcolor" transform="rotate(90.000000, 240.000000, 144.000000)"/><text text-anchor="middle" x="16" y="68" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="24" y="68" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="32" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="68" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="228" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="48" y="68" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="68" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="56" y="228" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="68" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="64" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="72" y="100" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="72" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="80" y="100" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="80" y="228" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="88" y="100" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="88" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="96" y="100" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="96" y="180" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="104" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="104" y="100" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="228" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="112" y="100" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="112" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="120" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="136" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="152" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="152" y="180" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="160" y="68" fill="currentcolor" style="font-size:1em">|</text><text text-anchor="middle" x="160" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="168" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="176" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="176" y="68" fill="currentcolor" style="font-size:1em">Q</text><text text-anchor="middle" x="176" y="180" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="184" y="68" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="192" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="180" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="200" y="68" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="200" y="180" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="208" y="68" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="208" y="180" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="216" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="68" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="224" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="224" y="68" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="180" fill="currentcolor" style="font-size:1em">r</text></g></svg></div><p>With <em>CQRS</em>, our data model may tend to become more specialized for writing as it becomes the <em>source of truth</em>. To fulfill reads requirements, we have several solutions: use <em>SQL views</em>, write some code to map the <em>readmodel</em> from the write model at runtime, or create and fill dedicated <em>SQL tables</em>. With all these solutions, this read/write separation becomes explicit in the code and we can evolve one part with a minimum impact on the other.</p><h2 id=executing-side-effects-consistency-as-a-target>Executing side-effects: consistency as a target</h2><p>Now we have isolated our business logic and made a clean separation between reads and writes, we should focus on what makes software useful: side-effects.</p><p>So far, I&rsquo;ve presented side-effects as something bad that must be pushed as far as we can from our domain, and there is good reason for that: by definition it&rsquo;s not deterministic, this means for the same input we will not always get the same output. Sometimes it&rsquo;s a different value, sometimes it can be more annoying like an error or a crash. Side-effects are difficult to test and it is hard to make sure our code is correct. But they&rsquo;re also necessary, they&rsquo;re the state changing in the database, the mail sent to the customer, or any other type of IO operations. Everything valuable produced by our software that is observable from the outside.</p><p>When our software is making changes, we’re seeking consistency, we want to make sure everything works fine, making a correct transition from a state A to a state B. That’s why we’re implicitly making a decision and at the same time applying it in the form of one or many side-effects. But if one of the side-effect fails, we can put ourselves in some inconsistent situation and this can be an issue: we may display wrong information to users, corrupted data may influence future decision-making, generating even more bad data. Making sure our system is always in a consistent state can be very complex or simply unachievable.</p><p>So we have to ask ourselves the hard question: What happens if something fails and how do we deal with failures? Yes, when talking about IO operations, failures will happen, never doubt that!</p><p>If we focus only on the database, there is a mechanism that can almost guarantee us a safe transition from state A to state B, even on complex queries combining multiple inserts, updates and deletes while complying with schema constraints: a <code>TRANSACTION</code>. Nothing new here, I bet you already knew about this and you were already using it in the previous architectures we&rsquo;ve explored. Though, the &ldquo;almost&rdquo; word was important. Be aware transactions are not perfect and some inconsistencies are still possible, especially if you&rsquo;re using database replication and/or partitioning. Don&rsquo;t try to develop your own solution to protect yourself from such cases, unless you&rsquo;re an expert, there is no chance that you do a better job than your database.</p><blockquote><p>On this very specific topic, I recommend to you the book <a href=https://www.oreilly.com/library/view/designing-data-intensive-applications/9781491903063/ target=_blank>Designing Data-Intensive Application</a> by <a href=https://bsky.app/profile/martin.kleppmann.com target=_blank>Martin Kleppmann</a>. It does an amazing job describing the internal operations of databases, how they deal with concurrence, replications, etc., and explaining how things can go wrong.</p></blockquote><p>It&rsquo;s getting even more complicated if our side-effects are spread across several dependencies, like updating our database and at the same time making a call to a third-party API. In such cases we&rsquo;ve got no mechanism like <code>TRANSACTION</code> to guaranty consistency. In case of a failure, we may need to set up compensation strategies to move back to a new consistent state. In the real world, such scenarios already exist and are well known by domain experts: &ldquo;Sorry, the item you bought on our site is no longer available, we will proceed to your refund&rdquo;. New scenarios like this will emerge as our software is now part of business processes. We should educate domain experts on them, explaining technical constraints and why these problems may occur. But we should also try to avoid as much failure scenarios as we can because they can undermine the whole business.</p><p>This compensation solution is necessary when we attempt something impossible or invalid from the business&rsquo;s point of view, but sometimes we&rsquo;re facing technical issues: the business intent is correct, but for some technical reasons we just cannot execute the operation right now (for example, the third-party API is unavailable). So, why not to defer this operation and retry it later?</p><p>A solution is to isolate these IO operations (other than database calls) in dedicated processes. By doing so, we&rsquo;re making sure it will not block the other side-effects and we now have the ability to retry them independently. A way to do this is to enqueue jobs in whatever suits your needs, then to execute them asynchronously in new processes.</p><blockquote><p>Hint: the database can do the job, have a look to <a href=https://docs.postgresql.fr/current/sql-listen.html target=_blank>PostgreSQL</a>&rsquo;s <code>LISTEN</code> for example.</p></blockquote><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 552 297"><g transform="translate(8,16)"><path d="M40 0H2e2" fill="none" stroke="currentcolor"/><path d="M40 32h72" fill="none" stroke="currentcolor"/><path d="M112 32h88" fill="none" stroke="currentcolor"/><path d="M0 64H8" fill="none" stroke="currentcolor"/><path d="M24 64h8" fill="none" stroke="currentcolor"/><path d="M40 64h8" fill="none" stroke="currentcolor"/><path d="M56 64h8" fill="none" stroke="currentcolor"/><path d="M72 64h8" fill="none" stroke="currentcolor"/><path d="M88 64h8" fill="none" stroke="currentcolor"/><path d="M104 64h8" fill="none" stroke="currentcolor"/><path d="M120 64h8" fill="none" stroke="currentcolor"/><path d="M136 64h8" fill="none" stroke="currentcolor"/><path d="M152 64h8" fill="none" stroke="currentcolor"/><path d="M168 64h8" fill="none" stroke="currentcolor"/><path d="M184 64h8" fill="none" stroke="currentcolor"/><path d="M2e2 64h8" fill="none" stroke="currentcolor"/><path d="M216 64h8" fill="none" stroke="currentcolor"/><path d="M280 64h16" fill="none" stroke="currentcolor"/><path d="M296 64h80" fill="none" stroke="currentcolor"/><path d="M264 80h16" fill="none" stroke="currentcolor"/><path d="M280 80h80" fill="none" stroke="currentcolor"/><path d="M40 96H208" fill="none" stroke="currentcolor"/><path d="M248 96h16" fill="none" stroke="currentcolor"/><path d="M264 96h80" fill="none" stroke="currentcolor"/><path d="M360 96h16" fill="none" stroke="currentcolor"/><path d="M424 96h96" fill="none" stroke="currentcolor"/><path d="M344 112h16" fill="none" stroke="currentcolor"/><path d="M40 128H64" fill="none" stroke="currentcolor"/><path d="M64 128H192" fill="none" stroke="currentcolor"/><path d="M192 128h16" fill="none" stroke="currentcolor"/><path d="M248 128h32" fill="none" stroke="currentcolor"/><path d="M280 128h64" fill="none" stroke="currentcolor"/><path d="M424 128h96" fill="none" stroke="currentcolor"/><path d="M0 160H8" fill="none" stroke="currentcolor"/><path d="M24 160h8" fill="none" stroke="currentcolor"/><path d="M40 160h8" fill="none" stroke="currentcolor"/><path d="M56 160h8" fill="none" stroke="currentcolor"/><path d="M72 160h8" fill="none" stroke="currentcolor"/><path d="M88 160h8" fill="none" stroke="currentcolor"/><path d="M104 160h8" fill="none" stroke="currentcolor"/><path d="M2e2 160h8" fill="none" stroke="currentcolor"/><path d="M216 160h8" fill="none" stroke="currentcolor"/><path d="M0 192H64" fill="none" stroke="currentcolor"/><path d="M64 192h96" fill="none" stroke="currentcolor"/><path d="M176 192h16" fill="none" stroke="currentcolor"/><path d="M192 192h88" fill="none" stroke="currentcolor"/><path d="M280 192h24" fill="none" stroke="currentcolor"/><path d="M0 224H160" fill="none" stroke="currentcolor"/><path d="M176 224H304" fill="none" stroke="currentcolor"/><path d="M0 256H24" fill="none" stroke="currentcolor"/><path d="M0 64V80" fill="none" stroke="currentcolor"/><path d="M0 104v16" fill="none" stroke="currentcolor"/><path d="M0 144v16" fill="none" stroke="currentcolor"/><path d="M0 192v32" fill="none" stroke="currentcolor"/><path d="M40 0V32" fill="none" stroke="currentcolor"/><path d="M40 96v32" fill="none" stroke="currentcolor"/><path d="M64 144v48" fill="none" stroke="currentcolor"/><path d="M112 32V80" fill="none" stroke="currentcolor"/><path d="M160 192v32" fill="none" stroke="currentcolor"/><path d="M176 192v32" fill="none" stroke="currentcolor"/><path d="M192 144v48" fill="none" stroke="currentcolor"/><path d="M2e2.0V32" fill="none" stroke="currentcolor"/><path d="M208 96v32" fill="none" stroke="currentcolor"/><path d="M224 64V80" fill="none" stroke="currentcolor"/><path d="M224 104v16" fill="none" stroke="currentcolor"/><path d="M224 144v16" fill="none" stroke="currentcolor"/><path d="M248 96v32" fill="none" stroke="currentcolor"/><path d="M264 80V96" fill="none" stroke="currentcolor"/><path d="M280 64V80" fill="none" stroke="currentcolor"/><path d="M280 144v48" fill="none" stroke="currentcolor"/><path d="M304 192v32" fill="none" stroke="currentcolor"/><path d="M344 96v16" fill="none" stroke="currentcolor"/><path d="M344 112v16" fill="none" stroke="currentcolor"/><path d="M360 80V96" fill="none" stroke="currentcolor"/><path d="M360 96v16" fill="none" stroke="currentcolor"/><path d="M376 64V96" fill="none" stroke="currentcolor"/><polygon points="32.000000,256.000000 20.000000,250.399994 20.000000,261.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 256.000000)"/><path d="M64 136v8" fill="none" stroke="currentcolor"/><polygon points="80.000000,144.000000 68.000000,138.399994 68.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 64.000000, 144.000000)"/><path d="M112 80v8" fill="none" stroke="currentcolor"/><polygon points="128.000000,80.000000 116.000000,74.400002 116.000000,85.599998" fill="currentcolor" transform="rotate(90.000000, 112.000000, 80.000000)"/><path d="M192 136v8" fill="none" stroke="currentcolor"/><polygon points="208.000000,144.000000 196.000000,138.399994 196.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 192.000000, 144.000000)"/><path d="M280 136v8" fill="none" stroke="currentcolor"/><polygon points="296.000000,144.000000 284.000000,138.399994 284.000000,149.600006" fill="currentcolor" transform="rotate(270.000000, 280.000000, 144.000000)"/><path d="M424 96a16 16 0 00-16 16" fill="none" stroke="currentcolor"/><path d="M520 96a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M408 112a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M536 112a16 16 0 01-16 16" fill="none" stroke="currentcolor"/><text text-anchor="middle" x="0" y="276" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="8" y="276" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="16" y="84" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="16" y="212" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="16" y="276" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="24" y="84" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="24" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="24" y="276" fill="currentcolor" style="font-size:1em">></text><text text-anchor="middle" x="32" y="84" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="32" y="212" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="40" y="260" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="40" y="276" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="48" y="84" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="48" y="276" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="56" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="260" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="56" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="64" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="64" y="260" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="276" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="72" y="212" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="72" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="72" y="276" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="80" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="80" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="260" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="80" y="276" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="88" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="260" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="88" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="20" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="96" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="104" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="116" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="104" y="260" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="20" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="212" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="260" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="120" y="116" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="120" y="164" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="120" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="128" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="128" y="212" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="136" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="136" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="164" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="136" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="144" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="144" y="212" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="152" y="20" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="152" y="164" fill="currentcolor" style="font-size:1em">q</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="160" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">y</text><text text-anchor="middle" x="168" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="176" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="176" y="164" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="184" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="212" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="208" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="216" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="224" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="232" y="212" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="240" y="212" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="248" y="212" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="264" y="212" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="272" y="116" fill="currentcolor" style="font-size:1em">P</text><text text-anchor="middle" x="272" y="212" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="280" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="280" y="212" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="288" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="288" y="164" fill="currentcolor" style="font-size:1em">S</text><text text-anchor="middle" x="296" y="116" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="296" y="164" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="304" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="304" y="164" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="312" y="116" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="312" y="164" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="320" y="116" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="320" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="376" y="116" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="384" y="116" fill="currentcolor" style="font-size:1em">=</text><text text-anchor="middle" x="392" y="116" fill="currentcolor" style="font-size:1em">></text><text text-anchor="middle" x="424" y="116" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="432" y="116" fill="currentcolor" style="font-size:1em">O</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="488" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="504" y="116" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="512" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="520" y="116" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>With such solution, a compensation may not be necessary anymore as our system is becoming <em>eventual consistent</em>. If something fails, it can be fixed and retried until it works. By the end of the day, our system will be consistent. Also, as processes are now isolated, we&rsquo;ve added a level of protection against cascading failures in our software, making it more resilient. I made a more detailed <a href=/posts/using-processes-for-better-resilience/>post</a> on this specific topic.</p><h2 id=explicit-decision-making>Explicit decision-making</h2><p>We&rsquo;re not done yet, I think we can go even further. As I&rsquo;ve already mentioned it in the previous section, we&rsquo;re implicitly making and applying decisions at the same time. This has a consequence, we may have made a valid decision but fail to apply it. In such case our decision has been rolled back and discarded. Now I want to change this behavior, making decisions explicit and not lose them if something else fails!</p><p>From now on, I&rsquo;ll refer to <em>readmodels</em> updating and jobs enqueuing as <em>effects</em>.</p><p>If we go back to our previous <em>CQRS</em> architecture, this means we should be able to update and save our write model. If it doesn&rsquo;t fail, then we can process our <em>effects</em>. With this, failing to run one of these <em>effects</em> doesn&rsquo;t cancel the decision made and should not affect other <em>effects</em> (to be applied or already applied).</p><blockquote><p>Hint: I would advise updating readmodels then enqueue jobs as job processing may sometimes rely on dedicated readmodels.</p></blockquote><p>One way to implement such a strategy is to aim for an <em>event-driven</em> architecture: our <em>domain</em> express decisions made in the form of <em>events</em>. Our code can look like something like this:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>EventA</span><span style=color:#111>(</span><span style=color:#111>values</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>EventB</span><span style=color:#111>(</span><span style=color:#111>values</span><span style=color:#111>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Aggregate</span><span style=color:#111>(</span><span style=color:#111>state</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Events</span><span style=color:#111>&gt;</span> <span style=color:#111>command</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>if</span> <span style=color:#111>(</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>0</span> <span style=color:#111>&amp;&amp;</span> <span style=color:#111>state</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span> <span style=color:#111>%</span> <span style=color:#ae81ff>2</span> <span style=color:#111>==</span> <span style=color:#ae81ff>1</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>      <span style=color:#00a8c8>yield</span> <span style=color:#00a8c8>return</span> <span style=color:#111>EventA</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#111>}</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>DomainService</span><span style=color:#111>(</span><span style=color:#111>DataAccess</span> <span style=color:#111>dataAccess</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>domainCommand</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#00a8c8>value</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#111>aggregate</span> <span style=color:#111>=</span> <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>dataAccess</span><span style=color:#111>.</span><span style=color:#111>load</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>var</span> <span style=color:#111>events</span> <span style=color:#111>=</span> <span style=color:#111>aggregate</span><span style=color:#111>.</span><span style=color:#111>command</span><span style=color:#111>(</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>dataAccess</span><span style=color:#111>.</span><span style=color:#111>save</span><span style=color:#111>(</span><span style=color:#111>id</span><span style=color:#111>,</span> <span style=color:#111>events</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>These <em>events</em> are then spread across our architecture and applied using <em>event-handlers</em>: first into our write model, and if no failure occurred (decision made on an obsolete version or the data violate one of the constraints of the database scheme), then we apply our <em>effects</em>.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 584 393"><g transform="translate(8,16)"><path d="M0 0H8" fill="none" stroke="currentcolor"/><path d="M24 0h8" fill="none" stroke="currentcolor"/><path d="M40 0h8" fill="none" stroke="currentcolor"/><path d="M56 0h8" fill="none" stroke="currentcolor"/><path d="M72 0h8" fill="none" stroke="currentcolor"/><path d="M88 0h8" fill="none" stroke="currentcolor"/><path d="M104 0h8" fill="none" stroke="currentcolor"/><path d="M120 0h8" fill="none" stroke="currentcolor"/><path d="M136 0h8" fill="none" stroke="currentcolor"/><path d="M144 0h8" fill="none" stroke="currentcolor"/><path d="M168 0h8" fill="none" stroke="currentcolor"/><path d="M184 0h8" fill="none" stroke="currentcolor"/><path d="M2e2.0h8" fill="none" stroke="currentcolor"/><path d="M216 0h8" fill="none" stroke="currentcolor"/><path d="M232 0h8" fill="none" stroke="currentcolor"/><path d="M248 0h8" fill="none" stroke="currentcolor"/><path d="M264 0h8" fill="none" stroke="currentcolor"/><path d="M24 32H128" fill="none" stroke="currentcolor"/><path d="M24 64H64" fill="none" stroke="currentcolor"/><path d="M64 64h64" fill="none" stroke="currentcolor"/><path d="M48 112H64" fill="none" stroke="currentcolor"/><path d="M64 112h48" fill="none" stroke="currentcolor"/><path d="M32 128H48" fill="none" stroke="currentcolor"/><path d="M48 128H96" fill="none" stroke="currentcolor"/><path d="M16 144H32" fill="none" stroke="currentcolor"/><path d="M32 144H80" fill="none" stroke="currentcolor"/><path d="M112 144h16" fill="none" stroke="currentcolor"/><path d="M96 160h16" fill="none" stroke="currentcolor"/><path d="M32 176H64" fill="none" stroke="currentcolor"/><path d="M64 176H96" fill="none" stroke="currentcolor"/><path d="M80 192h24" fill="none" stroke="currentcolor"/><path d="M192 192H296" fill="none" stroke="currentcolor"/><path d="M0 224H8" fill="none" stroke="currentcolor"/><path d="M24 224h8" fill="none" stroke="currentcolor"/><path d="M40 224h8" fill="none" stroke="currentcolor"/><path d="M56 224h8" fill="none" stroke="currentcolor"/><path d="M104 224h8" fill="none" stroke="currentcolor"/><path d="M120 224h8" fill="none" stroke="currentcolor"/><path d="M136 224h8" fill="none" stroke="currentcolor"/><path d="M144 224h8" fill="none" stroke="currentcolor"/><path d="M168 224h8" fill="none" stroke="currentcolor"/><path d="M184 224h8" fill="none" stroke="currentcolor"/><path d="M2e2 224h8" fill="none" stroke="currentcolor"/><path d="M248 224h8" fill="none" stroke="currentcolor"/><path d="M264 224h8" fill="none" stroke="currentcolor"/><path d="M16 256H64" fill="none" stroke="currentcolor"/><path d="M64 256h64" fill="none" stroke="currentcolor"/><path d="M160 256h48" fill="none" stroke="currentcolor"/><path d="M208 256h48" fill="none" stroke="currentcolor"/><path d="M288 256h24" fill="none" stroke="currentcolor"/><path d="M312 256h88" fill="none" stroke="currentcolor"/><path d="M16 288H128" fill="none" stroke="currentcolor"/><path d="M160 288h96" fill="none" stroke="currentcolor"/><path d="M288 288H4e2" fill="none" stroke="currentcolor"/><path d="M0 320H24" fill="none" stroke="currentcolor"/><path d="M0 0V16" fill="none" stroke="currentcolor"/><path d="M0 40V56" fill="none" stroke="currentcolor"/><path d="M0 72V88" fill="none" stroke="currentcolor"/><path d="M0 104v16" fill="none" stroke="currentcolor"/><path d="M0 136v16" fill="none" stroke="currentcolor"/><path d="M0 168v16" fill="none" stroke="currentcolor"/><path d="M0 208v16" fill="none" stroke="currentcolor"/><path d="M16 144v16" fill="none" stroke="currentcolor"/><path d="M16 256v32" fill="none" stroke="currentcolor"/><path d="M24 32V64" fill="none" stroke="currentcolor"/><path d="M32 128v16" fill="none" stroke="currentcolor"/><path d="M48 112v16" fill="none" stroke="currentcolor"/><path d="M64 64V96" fill="none" stroke="currentcolor"/><path d="M64 96v16" fill="none" stroke="currentcolor"/><path d="M64 176v64" fill="none" stroke="currentcolor"/><path d="M64 240v16" fill="none" stroke="currentcolor"/><path d="M96 160v16" fill="none" stroke="currentcolor"/><path d="M112 144v16" fill="none" stroke="currentcolor"/><path d="M128 32V64" fill="none" stroke="currentcolor"/><path d="M128 128v16" fill="none" stroke="currentcolor"/><path d="M128 256v32" fill="none" stroke="currentcolor"/><path d="M144 0V16" fill="none" stroke="currentcolor"/><path d="M144 40V56" fill="none" stroke="currentcolor"/><path d="M144 72V88" fill="none" stroke="currentcolor"/><path d="M144 104v16" fill="none" stroke="currentcolor"/><path d="M144 136v16" fill="none" stroke="currentcolor"/><path d="M144 168v16" fill="none" stroke="currentcolor"/><path d="M144 208v16" fill="none" stroke="currentcolor"/><path d="M160 256v32" fill="none" stroke="currentcolor"/><path d="M208 224v16" fill="none" stroke="currentcolor"/><path d="M208 240v16" fill="none" stroke="currentcolor"/><path d="M256 256v32" fill="none" stroke="currentcolor"/><path d="M272 0V16" fill="none" stroke="currentcolor"/><path d="M272 40V56" fill="none" stroke="currentcolor"/><path d="M272 72V88" fill="none" stroke="currentcolor"/><path d="M272 104v16" fill="none" stroke="currentcolor"/><path d="M272 136v16" fill="none" stroke="currentcolor"/><path d="M272 168v16" fill="none" stroke="currentcolor"/><path d="M272 208v16" fill="none" stroke="currentcolor"/><path d="M288 256v32" fill="none" stroke="currentcolor"/><path d="M312 224v16" fill="none" stroke="currentcolor"/><path d="M312 240v16" fill="none" stroke="currentcolor"/><path d="M4e2 256v32" fill="none" stroke="currentcolor"/><path d="M192 192l16 32" fill="none" stroke="currentcolor"/><path d="M296 192l16 32" fill="none" stroke="currentcolor"/><path d="M272 176v8" fill="none" stroke="currentcolor"/><path d="M272 2e2v8" fill="none" stroke="currentcolor"/><polygon points="32.000000,320.000000 20.000000,314.399994 20.000000,325.600006" fill="currentcolor" transform="rotate(0.000000, 24.000000, 320.000000)"/><path d="M64 96v8" fill="none" stroke="currentcolor"/><polygon points="80.000000,96.000000 68.000000,90.400002 68.000000,101.599998" fill="currentcolor" transform="rotate(90.000000, 64.000000, 96.000000)"/><path d="M64 240v8" fill="none" stroke="currentcolor"/><polygon points="80.000000,240.000000 68.000000,234.399994 68.000000,245.600006" fill="currentcolor" transform="rotate(90.000000, 64.000000, 240.000000)"/><polygon points="112.000000,192.000000 100.000000,186.399994 100.000000,197.600006" fill="currentcolor" transform="rotate(0.000000, 104.000000, 192.000000)"/><path d="M208 240v8" fill="none" stroke="currentcolor"/><polygon points="224.000000,240.000000 212.000000,234.399994 212.000000,245.600006" fill="currentcolor" transform="rotate(90.000000, 208.000000, 240.000000)"/><path d="M312 240v8" fill="none" stroke="currentcolor"/><polygon points="328.000000,240.000000 316.000000,234.399994 316.000000,245.600006" fill="currentcolor" transform="rotate(90.000000, 312.000000, 240.000000)"/><path d="M112 112a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M96 128a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M80 144a16 16 0 0116 16" fill="none" stroke="currentcolor"/><path d="M16 160a16 16 0 0016 16" fill="none" stroke="currentcolor"/><path d="M64 176a16 16 0 0016 16" fill="none" stroke="currentcolor"/><circle cx="0" cy="320" r="6" stroke="currentcolor" fill="#fff"/><circle cx="64" cy="64" r="6" stroke="currentcolor" fill="#fff"/><circle cx="64" cy="176" r="6" stroke="currentcolor" fill="#fff"/><circle cx="192" cy="192" r="6" stroke="currentcolor" fill="#fff"/><text text-anchor="middle" x="0" y="340" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="0" y="356" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="0" y="372" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="8" y="340" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="8" y="356" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="8" y="372" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="16" y="20" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="16" y="340" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="16" y="356" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="16" y="372" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="24" y="20" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="32" y="20" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="32" y="276" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="32" y="340" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="32" y="356" fill="currentcolor" style="font-size:1em">U</text><text text-anchor="middle" x="32" y="372" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="20" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="40" y="164" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="276" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="40" y="324" fill="currentcolor" style="font-size:1em">W</text><text text-anchor="middle" x="40" y="340" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="40" y="356" fill="currentcolor" style="font-size:1em">p</text><text text-anchor="middle" x="40" y="372" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="48" y="20" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="164" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="276" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="48" y="324" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="48" y="340" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="48" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="48" y="372" fill="currentcolor" style="font-size:1em">q</text><text text-anchor="middle" x="56" y="20" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">D</text><text text-anchor="middle" x="56" y="164" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="276" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="56" y="324" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="56" y="340" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="56" y="372" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="64" y="20" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="64" y="164" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="324" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="64" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="64" y="356" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="64" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="72" y="164" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="228" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="72" y="324" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="72" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="72" y="372" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="80" y="52" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="80" y="84" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="80" y="228" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="80" y="276" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="80" y="324" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="80" y="372" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="84" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="228" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="88" y="276" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="324" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="88" y="340" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="88" y="356" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="96" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="96" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="96" y="324" fill="currentcolor" style="font-size:1em">w</text><text text-anchor="middle" x="96" y="340" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="96" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="96" y="372" fill="currentcolor" style="font-size:1em">j</text><text text-anchor="middle" x="104" y="84" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="104" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="104" y="340" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="104" y="356" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="104" y="372" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="112" y="276" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="112" y="340" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="112" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="112" y="372" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="120" y="196" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="120" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="120" y="356" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="120" y="372" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="128" y="196" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="128" y="356" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="136" y="196" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="136" y="340" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="136" y="356" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="144" y="340" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="144" y="356" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="152" y="196" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="152" y="340" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="152" y="356" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="160" y="20" fill="currentcolor" style="font-size:1em">Q</text><text text-anchor="middle" x="160" y="196" fill="currentcolor" style="font-size:1em">k</text><text text-anchor="middle" x="160" y="340" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="20" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="168" y="196" fill="currentcolor" style="font-size:1em">?</text><text text-anchor="middle" x="168" y="340" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="176" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="176" y="276" fill="currentcolor" style="font-size:1em">R</text><text text-anchor="middle" x="184" y="20" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="184" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="192" y="20" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="276" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="200" y="20" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="200" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="208" y="20" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="208" y="276" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="216" y="228" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="216" y="276" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="224" y="228" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="224" y="276" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="232" y="228" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="232" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="276" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="304" y="276" fill="currentcolor" style="font-size:1em">M</text><text text-anchor="middle" x="312" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="320" y="228" fill="currentcolor" style="font-size:1em">(</text><text text-anchor="middle" x="320" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="328" y="228" fill="currentcolor" style="font-size:1em">3</text><text text-anchor="middle" x="328" y="276" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="336" y="228" fill="currentcolor" style="font-size:1em">)</text><text text-anchor="middle" x="336" y="276" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="344" y="276" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="352" y="276" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="368" y="276" fill="currentcolor" style="font-size:1em">b</text><text text-anchor="middle" x="376" y="276" fill="currentcolor" style="font-size:1em">u</text><text text-anchor="middle" x="384" y="276" fill="currentcolor" style="font-size:1em">s</text></g></svg></div><p>An <em>event-handler</em> is a straightforward piece of code:</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>EventHandler</span><span style=color:#111>(</span><span style=color:#111>DbAccess</span> <span style=color:#111>dbAccess</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>Handle</span><span style=color:#111>(</span><span style=color:#111>EventA</span> <span style=color:#111>@event</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// apply effect for EventA</span>
</span></span><span style=display:flex><span>    <span style=color:#111>dbAccess</span><span style=color:#111>.</span><span style=color:#111>execute</span><span style=color:#111>(</span>
</span></span><span style=display:flex><span>      <span style=color:#d88200>&#34;UPDATE myTable SET value = @value WHERE ...&#34;</span><span style=color:#111>,</span> 
</span></span><span style=display:flex><span>      <span style=color:#111>@event</span><span style=color:#111>.</span><span style=color:#00a8c8>value</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>void</span> <span style=color:#111>Handle</span><span style=color:#111>(</span><span style=color:#111>EventB</span> <span style=color:#111>@event</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// apply effect for EventB</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>// void Handle...</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>If one of our <em>effects</em> failed to apply, we now have the ability to retry later by logging the error, the <em>event</em> and the <em>event-handler</em> that failed. Be careful though <strong>not to leak</strong> sensitive information into the logs.</p><p>To be honest, from all the architectures explored in this blog post, this one is the one with which I have the least experience. I didn&rsquo;t achieve an implementation of the logging/retry mechanisms that really satisfied me, but with more hindsight I can think of two strategies that I believe are viable:</p><ul><li>store <em>events</em> in a dedicated table, each of them as an associated unique id, then log the combination <code>Event Id * Event Handler * Error</code></li><li>store the combination <code>Event Data * Event Handler * Error</code> in a dedicated table</li></ul><p>In both cases, the information available allows us to understand the failure and retry the <em>effects</em>. <em>Events</em> remains volatile and are not meant to be stored for long duration, so we need to put a flushing policy, like a dedicated process run daily that removes old <em>events</em>/errors. It may be after a week, a month.</p><p>My opinion is that making this split between decision-making and the implementation of the decision is the strongest move to improve your software architecture. It creates a highly resilient system with a supple design thanks decoupled elements (<em>events</em> and <em>handlers</em>). Though, I must highlight few things here: with <em>event-driven</em>, business processes are not always easy to follow and analyze as they&rsquo;re decomposed and spread across a lot places in our system. Also, our software became even more <em>eventual consistent</em> as we can fix unexpected errors and retry any <em>effect</em> later: this is all about error management. I know with <em>eventual consistency</em> it can be tempting to apply <em>effects</em> asynchronously but this can have major impacts on the user experience. Think how it can be disturbing if on your favorite e-commerce website an item doesn&rsquo;t appear in your cart after you have chosen to add one.</p><blockquote><p>Hint: By default I apply all my <em>effects</em> synchronously. In case of long operations, I use a dedicated <em>readmodel</em> where I write &ldquo;processing&rdquo;, then I enqueue a job to run the process in an asynchronous way. This way I&rsquo;m not blocking the user and she has a feedback that the operation she asked is ongoing.</p></blockquote><h2 id=do-not-lose-data>Do not lose data</h2><p>Here&rsquo;s the final refinement I want to suggest. All our previous architectures suffer from the same flaw: our database model remained handled in a <em>CRUD</em> fashion. This can be an issue in the write model as we&rsquo;re implicitly losing data every time we&rsquo;re updating a value. Yes, Update is an implicit Delete as we lose the replaced value.</p><p>New features may not be compatible with existing data. Missing data may also prevent us from correcting incorrect values due to bugs or mishandling by users. Analyzing the past is an opportunity to discover trends, doing statistics and improve future business decisions.</p><p>To mitigate this issue, I want to move from an <em>event-driven CQRS</em> architecture to the <em>CQRS/Event-Sourcing</em> architecture. To do this, we &ldquo;just&rdquo; have to store our <em>events</em> instead of a state in our write model. By doing so, our model is now in <em>append only</em> mode, technical issues put aside, the only way to fail is a conflict. This allows us to easily detect concurrent operations on a same <em>event stream</em> (the list of the <em>events</em> that were emitted by an <em>aggregate</em>), the version of the <em>event stream</em> is the number of <em>events</em> that composes it: if we try to insert an event with a number that already exists, we&rsquo;re in a conflict.</p><div class="goat svg-container"><svg xmlns="http://www.w3.org/2000/svg" font-family="Menlo,Lucida Console,monospace" viewBox="0 0 672 265"><g transform="translate(8,16)"><path d="M16 32h96" fill="none" stroke="currentcolor"/><path d="M216 32h96" fill="none" stroke="currentcolor"/><path d="M424 32h96" fill="none" stroke="currentcolor"/><path d="M16 64h96" fill="none" stroke="currentcolor"/><path d="M216 64h96" fill="none" stroke="currentcolor"/><path d="M424 64h96" fill="none" stroke="currentcolor"/><path d="M16 96h96" fill="none" stroke="currentcolor"/><path d="M216 96h96" fill="none" stroke="currentcolor"/><path d="M424 96h96" fill="none" stroke="currentcolor"/><path d="M16 128h96" fill="none" stroke="currentcolor"/><path d="M216 128h96" fill="none" stroke="currentcolor"/><path d="M424 128h96" fill="none" stroke="currentcolor"/><path d="M16 160h96" fill="none" stroke="currentcolor"/><path d="M216 160h56" fill="none" stroke="currentcolor"/><path d="M272 160h40" fill="none" stroke="currentcolor"/><path d="M312 160h56" fill="none" stroke="currentcolor"/><path d="M424 160h96" fill="none" stroke="currentcolor"/><path d="M560 160h96" fill="none" stroke="currentcolor"/><path d="M240 176h24" fill="none" stroke="currentcolor"/><path d="M272 192h96" fill="none" stroke="currentcolor"/><path d="M424 192h96" fill="none" stroke="currentcolor"/><path d="M560 192h96" fill="none" stroke="currentcolor"/><path d="M0 224H24" fill="none" stroke="currentcolor"/><path d="M16 32V64" fill="none" stroke="currentcolor"/><path d="M16 64V96" fill="none" stroke="currentcolor"/><path d="M16 96v32" fill="none" stroke="currentcolor"/><path d="M16 128v32" fill="none" stroke="currentcolor"/><path d="M112 32V64" fill="none" stroke="currentcolor"/><path d="M112 64V96" fill="none" stroke="currentcolor"/><path d="M112 96v32" fill="none" stroke="currentcolor"/><path d="M112 128v32" fill="none" stroke="currentcolor"/><path d="M216 32V64" fill="none" stroke="currentcolor"/><path d="M216 64V96" fill="none" stroke="currentcolor"/><path d="M216 96v32" fill="none" stroke="currentcolor"/><path d="M216 128v32" fill="none" stroke="currentcolor"/><path d="M272 160v32" fill="none" stroke="currentcolor"/><path d="M312 32V64" fill="none" stroke="currentcolor"/><path d="M312 64V96" fill="none" stroke="currentcolor"/><path d="M312 96v32" fill="none" stroke="currentcolor"/><path d="M312 128v32" fill="none" stroke="currentcolor"/><path d="M368 160v32" fill="none" stroke="currentcolor"/><path d="M424 32V64" fill="none" stroke="currentcolor"/><path d="M424 64V96" fill="none" stroke="currentcolor"/><path d="M424 96v32" fill="none" stroke="currentcolor"/><path d="M424 128v32" fill="none" stroke="currentcolor"/><path d="M424 160v32" fill="none" stroke="currentcolor"/><path d="M520 32V64" fill="none" stroke="currentcolor"/><path d="M520 64V96" fill="none" stroke="currentcolor"/><path d="M520 96v32" fill="none" stroke="currentcolor"/><path d="M520 128v32" fill="none" stroke="currentcolor"/><path d="M520 160v32" fill="none" stroke="currentcolor"/><path d="M560 160v32" fill="none" stroke="currentcolor"/><path d="M656 160v32" fill="none" stroke="currentcolor"/><polygon points="8.000000,224.000000 -4.000000,218.399994 -4.000000,229.600006" fill="currentcolor" transform="rotate(180.000000, 0.000000, 224.000000)"/><polygon points="8.000000,240.000000 -4.000000,234.399994 -4.000000,245.600006" fill="currentcolor" transform="rotate(180.000000, 0.000000, 240.000000)"/><polygon points="248.000000,176.000000 236.000000,170.399994 236.000000,181.600006" fill="currentcolor" transform="rotate(180.000000, 240.000000, 176.000000)"/><polygon points="536.000000,176.000000 524.000000,170.399994 524.000000,181.600006" fill="currentcolor" transform="rotate(180.000000, 528.000000, 176.000000)"/><text text-anchor="middle" x="0" y="4" fill="currentcolor" style="font-size:1em">I</text><text text-anchor="middle" x="8" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="8" y="244" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="16" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="16" y="244" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="24" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="24" y="244" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="32" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="40" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="40" y="52" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="84" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="116" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="148" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="40" y="228" fill="currentcolor" style="font-size:1em">V</text><text text-anchor="middle" x="40" y="244" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="48" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="48" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="84" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="116" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="148" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="48" y="228" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="48" y="244" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="56" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="56" y="228" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="56" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="64" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="64" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="64" y="244" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="72" y="4" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="72" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="72" y="228" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="72" y="244" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="80" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="80" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="88" y="52" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="88" y="84" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="88" y="116" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="88" y="148" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="88" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="88" y="244" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="96" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="96" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="96" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="104" y="228" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="104" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="112" y="4" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="112" y="228" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="112" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="120" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="120" y="228" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="120" y="244" fill="currentcolor" style="font-size:1em">g</text><text text-anchor="middle" x="128" y="4" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="128" y="228" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="136" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="136" y="228" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="136" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="144" y="4" fill="currentcolor" style="font-size:1em">a</text><text text-anchor="middle" x="144" y="228" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="144" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="152" y="4" fill="currentcolor" style="font-size:1em">m</text><text text-anchor="middle" x="152" y="228" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="152" y="244" fill="currentcolor" style="font-size:1em">s</text><text text-anchor="middle" x="160" y="244" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="168" y="244" fill="currentcolor" style="font-size:1em">r</text><text text-anchor="middle" x="176" y="244" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="184" y="244" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="192" y="244" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="200" y="4" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="200" y="244" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="208" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="216" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="232" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="240" y="4" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="240" y="52" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="240" y="84" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="240" y="116" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="240" y="148" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="248" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="248" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="248" y="84" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="248" y="116" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="248" y="148" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="256" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="256" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="256" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="264" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="264" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="264" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="264" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="264" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="272" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="272" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="272" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="288" y="4" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="288" y="52" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="288" y="84" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="288" y="116" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="288" y="148" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="288" y="180" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="296" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="296" y="180" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="304" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="312" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="312" y="180" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="320" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="320" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="328" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="336" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="336" y="180" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="344" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="344" y="180" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="352" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="352" y="180" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="360" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="368" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="408" y="4" fill="currentcolor" style="font-size:1em">A</text><text text-anchor="middle" x="416" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="424" y="4" fill="currentcolor" style="font-size:1em">d</text><text text-anchor="middle" x="440" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="440" y="180" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="448" y="4" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="448" y="52" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="448" y="84" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="448" y="116" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="448" y="148" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="448" y="180" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="456" y="4" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="456" y="52" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="456" y="84" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="456" y="116" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="456" y="148" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="456" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="464" y="52" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="84" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="116" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="148" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="464" y="180" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="472" y="52" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="84" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="116" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="148" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="472" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="4" fill="currentcolor" style="font-size:1em">:</text><text text-anchor="middle" x="480" y="52" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="84" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="116" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="480" y="148" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="488" y="180" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="496" y="4" fill="currentcolor" style="font-size:1em">C</text><text text-anchor="middle" x="496" y="52" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="496" y="84" fill="currentcolor" style="font-size:1em">2</text><text text-anchor="middle" x="496" y="116" fill="currentcolor" style="font-size:1em">…</text><text text-anchor="middle" x="496" y="148" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="496" y="180" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="504" y="4" fill="currentcolor" style="font-size:1em">o</text><text text-anchor="middle" x="504" y="180" fill="currentcolor" style="font-size:1em">1</text><text text-anchor="middle" x="512" y="4" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="520" y="4" fill="currentcolor" style="font-size:1em">f</text><text text-anchor="middle" x="528" y="4" fill="currentcolor" style="font-size:1em">l</text><text text-anchor="middle" x="536" y="4" fill="currentcolor" style="font-size:1em">i</text><text text-anchor="middle" x="536" y="180" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="544" y="4" fill="currentcolor" style="font-size:1em">c</text><text text-anchor="middle" x="544" y="180" fill="currentcolor" style="font-size:1em">x</text><text text-anchor="middle" x="552" y="4" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="552" y="180" fill="currentcolor" style="font-size:1em">-</text><text text-anchor="middle" x="576" y="180" fill="currentcolor" style="font-size:1em">E</text><text text-anchor="middle" x="584" y="180" fill="currentcolor" style="font-size:1em">v</text><text text-anchor="middle" x="592" y="180" fill="currentcolor" style="font-size:1em">e</text><text text-anchor="middle" x="600" y="180" fill="currentcolor" style="font-size:1em">n</text><text text-anchor="middle" x="608" y="180" fill="currentcolor" style="font-size:1em">t</text><text text-anchor="middle" x="624" y="180" fill="currentcolor" style="font-size:1em">N</text><text text-anchor="middle" x="632" y="180" fill="currentcolor" style="font-size:1em">+</text><text text-anchor="middle" x="640" y="180" fill="currentcolor" style="font-size:1em">1</text></g></svg></div><p>We also have to rebuild the internal state of our <em>aggregate</em> from an <em>event stream</em>, this operation can be expressed as a simple <code>leftFold</code> (<a href=https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.aggregate target=_blank><code>Aggregate</code></a> in .Net, <a href=https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Global_Objects/Array/reduce target=_blank><code>redude</code></a> in Javascript).</p><div class=highlight><pre tabindex=0 style=color:#272822;background-color:#fafafa;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#00a8c8>class</span> <span style=color:#75af00>Aggregate</span><span style=color:#111>()</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>  <span style=color:#00a8c8>private</span> <span style=color:#111>State</span> <span style=color:#111>state</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#111>ctor</span><span style=color:#111>(</span><span style=color:#111>List</span><span style=color:#111>&lt;</span><span style=color:#111>Events</span><span style=color:#111>&gt;</span> <span style=color:#111>history</span><span style=color:#111>)</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>    <span style=color:#00a8c8>this</span><span style=color:#111>.</span><span style=color:#111>state</span> <span style=color:#111>=</span> 
</span></span><span style=display:flex><span>      <span style=color:#111>history</span><span style=color:#111>.</span><span style=color:#111>leftFold</span><span style=color:#111>((</span><span style=color:#111>state</span><span style=color:#111>,</span> <span style=color:#111>@event</span><span style=color:#111>)</span> <span style=color:#111>=&gt;</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>        <span style=color:#111>@event</span> <span style=color:#00a8c8>switch</span> <span style=color:#111>{</span>
</span></span><span style=display:flex><span>          <span style=color:#00a8c8>case</span> <span style=color:#111>EventA</span> <span style=color:#111>eventA</span> <span style=color:#111>=&gt;</span> <span style=color:#75715e>// apply event</span>
</span></span><span style=display:flex><span>          <span style=color:#00a8c8>case</span> <span style=color:#111>EventB</span> <span style=color:#111>eventB</span> <span style=color:#111>=&gt;</span> <span style=color:#75715e>// apply event</span>
</span></span><span style=display:flex><span>          <span style=color:#00a8c8>default</span> <span style=color:#111>=&gt;</span> <span style=color:#111>state</span>
</span></span><span style=display:flex><span>        <span style=color:#111>}</span>
</span></span><span style=display:flex><span>      <span style=color:#111>},</span> <span style=color:#111>initialState</span><span style=color:#111>)</span>
</span></span><span style=display:flex><span>  <span style=color:#111>}</span>
</span></span><span style=display:flex><span><span style=color:#111>}</span>
</span></span></code></pre></div><p>However, don&rsquo;t believe CQRS/ES is &ldquo;just&rdquo; storing and folding <em>events</em> of our initial <em>event-driven</em> architecture. In addition to communication, our <em>events</em> are now used for storage purposes (this is their main role), this means they&rsquo;re not volatile anymore.</p><p>We&rsquo;ll have to set up a good serialization strategy as well as a versioning/migration policy. These topics are critical and must be considered seriously.</p><p>From the developer point of view, handling <em>event streams</em> also require good knowledge about the application: what is a valid <em>stream</em>? What <em>events</em> are in that stream? In what order? This can be tricky to hold all this information in our mind, especially for complex <em>aggregates</em>.</p><p>We also have to put extra care into our <em>events</em> design as we&rsquo;ll have to manipulate them over long periods. A bad design can really hurt our development velocity in the long run. I wrote a dedicated <a href=/posts/cqrs-es-how-to-achieve-a-good-event-granularity/>post</a> where I explain my heuristics to find good <em>events</em>.</p><p>Loading several objects in the form of a tree becomes really tricky and it&rsquo;s way better to link aggregates using references (pass an id instead of the object). I would advise you to do this even before considering <em>event-sourcing</em>, but with this architecture you don&rsquo;t really have a choice.</p><p>Finally, <em>event-sourcing</em> doesn&rsquo;t tell us the whole story: unless we treat business errors as <em>events</em>, we will only observe in our <em>events</em> the result of successful commands. When we analyze trends in production, this is something that we need to keep in mind.</p><p><em>CQRS/Event-Sourcing</em> is the most advanced architecture pattern I&rsquo;ve used in production during my career. I love it because it allows me to write reliable and resilient software, but as I&rsquo;ve highlighted it, this is not an easy pattern to use. There are probably some new refinements we could imagine to improve this architecture, but they&rsquo;re out of my current knowledge.</p><h2 id=conclusion>Conclusion</h2><p>In this blog post, we&rsquo;ve gone through several architectures by adding improvements. As they grow in capabilities, they also grow in complexity.</p><p>Keep in mind that not all applications need the most advanced <em>CQRS/Event-Sourcing</em> pattern. Choose the architecture that is good enough for the problems you&rsquo;re trying to solve. Even more, we don&rsquo;t have to write an entire software using a single architecture. In a given context, some parts are well defined with clear life-cycles and therefore can be <em>event-sourced</em>. Other parts may be well suited for a simple <em>CRUD</em> approach as they have no life-cycle nor business rules. Mixing these patterns isn&rsquo;t an issue at all.</p><p>I&rsquo;m also aware we&rsquo;ve not explored all architectures that exist out-there. For example, I know about the <em><a href=https://en.wikipedia.org/wiki/Actor_model target=_blank>actor-model pattern</a></em> or the <em><a href=https://www.jimmybogard.com/vertical-slice-architecture/ target=_blank>vertical slice architecture</a></em> but I chose not to talk about these in this post as I wanted to focus on architectures I&rsquo;ve used in a production context.</p><p>Finally, even if our architectures have increased in complexity, it doesn&rsquo;t mean that the cost of the software is growing with it. Sure, it requires more skilled developers and the initial cost of a new feature may be higher, but we have to consider how the code complexity is contained over time, how costly it is to run and maintain the software in production, etc. Increased initial development cost can result in lower maintenance, production and evolution costs. That&rsquo;s why only looking at the development costs to drive a technical choice doesn&rsquo;t make sense to me. This is also the reason why I don’t think these advanced architectures are necessarily more expensive.</p><blockquote><h3 id=edit-20250423>Edit: 2025/04/23</h3><p>In this post, I&rsquo;ve described how to gradually move from a state-based persistence model to an <em>event-sourced</em> solution, but I did it with a macroscopic view of our architectures. Since then, I&rsquo;ve published another <a href=/posts/from-a-state-based-to-an-event-sourced-codebase>post</a> where I detail how to do such migrations of a codebase in tiny steps.</p></blockquote><hr><h2 id=comments>Comments</h2><p>Wish to comment? Please, add your comment by <a href="https://github.com/RomainTrm/Blog?tab=readme-ov-file#how-to-comment" target=_blank>sending me a pull request</a>.</p></article><div class=tags><span title=Tags>🏷</span><div class="horizontal-links links"><a href=/tags/post/>Post</a><a href=/tags/en/>En</a></div></div></article></main><footer><div class=content-container><div class=content><div class=about><h2>Romain Berthon</h2>Software developer, *DD and F# enthusiast<p class=horizontal-links><a href=https://github.com/RomainTrm target=_blank>Github</a><a href=https://bsky.app/profile/berthon.dev target=_blank>Bsky</a><a href=https://fr.linkedin.com/in/romain-berthon-254977101 target=_blank>LinkedIn</a></p></div></div></div></footer></body></html>